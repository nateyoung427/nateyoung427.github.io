<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Java Never Sleep</title>
  
  <subtitle>Me Not, Me Sleep</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.javaneversleep.com/"/>
  <updated>2020-03-26T20:46:32.564Z</updated>
  <id>http://www.javaneversleep.com/</id>
  
  <author>
    <name>Nathanael Yang</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>给一位Udemy学员的回复（之一）：Follow Design Pattern的正确姿势</title>
    <link href="http://www.javaneversleep.com/Reply-On-How-to-Follow-Design-Pattern/"/>
    <id>http://www.javaneversleep.com/Reply-On-How-to-Follow-Design-Pattern/</id>
    <published>2020-03-26T16:52:43.000Z</published>
    <updated>2020-03-26T20:46:32.564Z</updated>
    
    <content type="html"><![CDATA[<p>去年在Udemy上发了两门课，算是了却了一桩心事，当然，也多出来N桩心事——时不时有学员就“<a href="https://www.udemy.com/course/java-warrior-part1/?referralCode=5777839AB585A9602DFE" target="_blank" rel="noopener">放码过来！作个Java实战派</a>”、“<a href="https://www.udemy.com/course/java-tank-war/?couponCode=JAVANEVERSLEEP-MAR20" target="_blank" rel="noopener">放码过来！新版Java坦克大战</a>”提问，目前为止，所有提问我都按承诺24小时内回复——当然，通常是几小时内就回复。但是，一位学员来信提到的下面这个问题，我却首次破例了😔</p><p><a href="https://www.udemy.com/course/java-tank-war/?couponCode=JAVANEVERSLEEP-MAR20" target="_blank" rel="noopener"><img src="/img/udemy-tankwar.jpg" alt=""></a><a id="more"></a></p><p>这位台湾小帅哥问的是什么呢？</p><blockquote><p>Nathanael老師您好, 我即將完成您的tank課程！這一路學到很多, 但是也有發現自己有很多不足。特別是在OOD的部分, 很難想到像老師您一樣有系統性的去設計一個一個的class, 想請問老師您有follow什麼Design pattern嗎？</p><p>另外, 我想將這個project寫在履歷上, 但是我沒有做過這種project, 所以我不知道從何寫起, 以及一個面試官, 一個senior希望從這個項目看到什麼樣的重點及技能。能不能請老師稍微分享一下您的經驗, 若您是面試官, 您希望在這個project上看到我學會了什麼, 以及什麼市值得寫在履歷上的呢？<br>另外雖然我是一個newbie, 但是希望老師之後課程可以加入一個design pattern 或是一個更詳細high level 的 project idea, 謝謝老師的教導～！</p></blockquote><p>为了回答这些问题，我至少掉了三十根头发。厌烦絮叨，只想看看该如何行动的急性子，可以直接跳到“<a href="#读一本书，行万里路">读一本书，行万里路</a>”。</p><h3 id="我Follow了什么Design-Pattern？"><a href="#我Follow了什么Design-Pattern？" class="headerlink" title="我Follow了什么Design Pattern？"></a>我Follow了什么Design Pattern？</h3><p>长话短说，我没有刻意Follow什么Design Pattern。对坦克大战这样一个小型项目，设计Class实际是水到渠成的过程。分析需求、迭代开发和测试，一个个Class的出现就会是顺理成章的事情。这些Class的一些共性，随着开发过程的深入会慢慢浮现出来，在此基础上，我们可以作一些必要的抽象和剥离，比如<a href="https://github.com/ny83427/tankwar/blob/solution/src/GameObject.java" target="_blank" rel="noopener"><code>GameObject</code></a>是在后期——而不是一开始就出现。</p><p>有两种思考进路：先具体再抽象，先抽象再具体。体现在开发过程中，可能就是在动手写代码之前，设计、规划需要做到何种程度的问题。这两种进路，根据情况的不同，使用的方式也不同。但大体来说，我更习惯于先具体再抽象，因为这更能保证抽象是必要的、最小的。可能有人担心没有想清楚就开干是否会导致很多返工，有可能，但是不幸的是，我不是那种一开始就可以想清楚的人😭当然，这并不可怕，有重构和各类测试保驾护航，小改、大改甚至魔改都不是问题。</p><p>实际上，“很難想到像老師您一樣有系統性的去設計一個一個的class”，这主要是一个经验积累的问题，与Design Pattern几乎无关。完成的项目越多，掉进的坑、踩过的雷越多，当拿到一个需求并完成分析之后，OOD的设计会在自然不断的迭代中完成更新，并逐步达到一个较为理想的状态。所以，少年，日写代码三百行，不辞长作程序猿。</p><p>我所参与不同公司的项目中，通常当一个Feature下来之后，项目组的资深架构师会要求开发人员完成一个初始设计并进行评审，其主要目的是避免开发人员的思路太不合理——以致几乎可以确定这么折腾必定会埋下N多地雷，评审不会期望在正式开发之前，可以事无巨细、面面俱到地规划未来。</p><h3 id="Follow-Design-Pattern的正确姿势"><a href="#Follow-Design-Pattern的正确姿势" class="headerlink" title="Follow Design Pattern的正确姿势"></a>Follow Design Pattern的正确姿势</h3><p>先下结论：根据需要Follow，为了让代码变得更好去Follow。这很废话，但是我也只能这么说了，抱歉。</p><p>比如坦克大战中，<code>GameClient</code>是个全局唯一的对象，那么，当游戏中的其他对象需要访问它时，我们需要确保<code>GameClient</code>在虚拟机中只有一个实例，如何做到？</p><p>单例模式（Singleton）就自然而然出现，饿汉式（Eager Singleton）单例也会是我们的第一选择：最简单、最易于实现。</p><p>饿汉式单例可以运行得很好，直到某天你发现，为了让饿汉吃饱，为了让这个单例被构建出来，系统的启动时间显著增加了，而实际上系统启动时我们并不需要这条汉子，仅仅只在某个下雨的星期天，我们才想起这汉子，叫他给我们送外卖。</p><p>于是懒汉式（Lazy Initial Singleton）应运而生，仅当第一次用到时，才去初始化。</p><p>懒汉式单例可以运行得很好，直到某天你发现，有一定的概率，系统中悲剧地出现了两条汉子——天下大乱了！</p><p>于是懒汉式单例的线程安全问题浮出水面，方法级<code>synchronized</code>，还是代码块<code>synchronized</code>，如果是代码块<code>synchronized</code>，是否需要双保险才能保障？</p><p>单例问题、模式似乎就到此终止了，直到某天你发现，前Google工程师Bob Lee在折腾<a href="http://blog.crazybob.org/2007/01/lazy-loading-singletons.html" target="_blank" rel="noopener">Initialization on Demand Holder (IODH) idiom</a>，你不禁感叹：还能这么玩？</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonHolder</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> Singleton instance = <span class="keyword">new</span> Singleton();    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> SingletonHolder.instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看清楚了吗少年？我们不需要刻意Follow什么Pattern，但是在解决一个个问题的过程中，我们会自然而然地接触到这些Pattern，了解它们合适的使用场景。某些时候，像Crazy Bob这样脑洞清奇的大牛，还能时不时给你来点猛料和惊喜😄</p><p>接下来我们再谈一下“为了让代码变得更好去Follow”，这里的好代码，我们尽可能不搞印象派，而暂时只从以下三个方面衡量：</p><ul><li>代码Bug多吗？测试同事喜欢你吗？</li><li>需求变更，改起来方便快捷吗？改完之后心里踏实吗，还是要烧香拜佛？</li><li>代码方便测试、易于测试吗？还是改完之后因为太难测试，干脆就不测试了？</li></ul><p>就先只谈这三个很直观的方面，暂时略过其他不太直观的东东。</p><p>设计模式使用得当，可以确凿无疑地让代码易于测试、易于维护、Bug最少，实际上，代码写多了，出于对更高更强更快的追求和折腾，有一些设计模式你会无师自通，因为英雄所见，一般都略同嘛。</p><p>比如，你受不了裸写JDBC这种非人类的搞法，你发现模板模式让你的生活多少美好了一些：你要写的代码显著变少了，容易搞出问题的复制黏贴基本没了，要升级到数据库连接池也只需要修改一处了…</p><h3 id="读一本书，行万里路"><a href="#读一本书，行万里路" class="headerlink" title="读一本书，行万里路"></a>读一本书，行万里路</h3><p>最后，我的建议是快速通读一本关于设计模式的好书，然后丢下它，在痛苦而漫长的代码生涯中去自然而然地Follow他们。为赋新词强说愁的Follow方式很危险，很容易为了设计模式而设计模式。</p><p>如果只能推荐一本，那么我会推荐这本小人书：<a href="https://amzn.to/2vQ4YcA" target="_blank" rel="noopener">Head First Design Patterns: A Brain-Friendly Guide</a>，中文译本是“<a href="https://amzn.to/2wGRT5L" target="_blank" rel="noopener">深入浅出设计模式</a>”。相信我，她比四人帮的名著更适合绝大部分人。</p><p><a href="https://amzn.to/2vQ4YcA" target="_blank" rel="noopener"><img src="/img/head-first-design-patterns.jpg" alt=""></a></p><p>关于这个项目如何用在简历中的问题，下回再说，等掉够了四十根头发，应该就成了。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;去年在Udemy上发了两门课，算是了却了一桩心事，当然，也多出来N桩心事——时不时有学员就“&lt;a href=&quot;https://www.udemy.com/course/java-warrior-part1/?referralCode=5777839AB585A9602DFE&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;放码过来！作个Java实战派&lt;/a&gt;”、“&lt;a href=&quot;https://www.udemy.com/course/java-tank-war/?couponCode=JAVANEVERSLEEP-MAR20&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;放码过来！新版Java坦克大战&lt;/a&gt;”提问，目前为止，所有提问我都按承诺24小时内回复——当然，通常是几小时内就回复。但是，一位学员来信提到的下面这个问题，我却首次破例了😔&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.udemy.com/course/java-tank-war/?couponCode=JAVANEVERSLEEP-MAR20&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;img src=&quot;/img/udemy-tankwar.jpg&quot; alt=&quot;&quot;&gt;&lt;/a&gt;
    
    </summary>
    
      <category term="Udemy教程" scheme="http://www.javaneversleep.com/categories/Udemy%E6%95%99%E7%A8%8B/"/>
    
    
      <category term="Udemy Course" scheme="http://www.javaneversleep.com/tags/Udemy-Course/"/>
    
      <category term="技术面试" scheme="http://www.javaneversleep.com/tags/%E6%8A%80%E6%9C%AF%E9%9D%A2%E8%AF%95/"/>
    
      <category term="设计模式" scheme="http://www.javaneversleep.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>Java Never Sleep YouTube频道开通啦！天天向上～</title>
    <link href="http://www.javaneversleep.com/YouTube-Channel-is-Ready-Day-Day-Up-Java-Warrior-and-Tank-War/"/>
    <id>http://www.javaneversleep.com/YouTube-Channel-is-Ready-Day-Day-Up-Java-Warrior-and-Tank-War/</id>
    <published>2019-06-13T00:03:33.000Z</published>
    <updated>2020-03-17T23:22:01.743Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://www.youtube.com/channel/UClFNjZxKXLa8LpBj2m4PCDg?sub_confirmation=1" target="_blank" rel="noopener">Java Never Sleep</a> YouTube频道开通啦！经过N多朋友鼎力相助，24小时内搞定了100个Subscriber，专属地址已经申请下来：<a href="https://www.youtube.com/JavaNeverSleep" target="_blank" rel="noopener">https://www.youtube.com/JavaNeverSleep</a> 。欢迎访问、订阅、点赞、评论～🤝</p><div class="video-container"><iframe src="//www.youtube.com/embed/urKOqWyKVWs" frameborder="0" allowfullscreen></iframe></div><a id="more"></a><p>目前总计有三个播放列表，值得一提的是，“天天向上”今日刚刚开通：</p><ul><li><a href="https://www.youtube.com/watch?v=urKOqWyKVWs&amp;list=PLn-f9VrE6rnsswb-Ke_dMzam-jQHUZMZy" target="_blank" rel="noopener">天天向上</a></li></ul><blockquote><p>天天向上，是件知易行难的事情。从6月11日开始的100天内，我计划每天上传一个或干货、或搞笑、或扯淡的视频，最低限度，这视频能让自己和听众受益，真正作到天天向上。</p><p>百日维新，天天向上～🙏</p></blockquote><ul><li><a href="https://www.youtube.com/watch?v=XGfwh9RpsLk&amp;list=PLn-f9VrE6rnv5P3JLK9JiU6NMRL6s6Uiy" target="_blank" rel="noopener">放码过来！作个Java实战派</a></li><li><a href="https://www.youtube.com/watch?v=wNYWz5ZFzbs&amp;list=PLn-f9VrE6rntTznAGwi1LaRywDS0_o79_" target="_blank" rel="noopener">放码过来！新版Java坦克大战</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://www.youtube.com/channel/UClFNjZxKXLa8LpBj2m4PCDg?sub_confirmation=1&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Java Never Sleep&lt;/a&gt; YouTube频道开通啦！经过N多朋友鼎力相助，24小时内搞定了100个Subscriber，专属地址已经申请下来：&lt;a href=&quot;https://www.youtube.com/JavaNeverSleep&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://www.youtube.com/JavaNeverSleep&lt;/a&gt; 。欢迎访问、订阅、点赞、评论～🤝&lt;/p&gt;
&lt;div class=&quot;video-container&quot;&gt;&lt;iframe src=&quot;//www.youtube.com/embed/urKOqWyKVWs&quot; frameborder=&quot;0&quot; allowfullscreen&gt;&lt;/iframe&gt;&lt;/div&gt;
    
    </summary>
    
      <category term="YouTube" scheme="http://www.javaneversleep.com/categories/YouTube/"/>
    
    
      <category term="YouTube" scheme="http://www.javaneversleep.com/tags/YouTube/"/>
    
  </entry>
  
  <entry>
    <title>“放码过来！新版Java坦克大战”课程大纲</title>
    <link href="http://www.javaneversleep.com/Udemy-Course-Show-me-the-Code-Java-Tank-War-Curriculum/"/>
    <id>http://www.javaneversleep.com/Udemy-Course-Show-me-the-Code-Java-Tank-War-Curriculum/</id>
    <published>2019-06-10T22:16:14.000Z</published>
    <updated>2020-03-20T16:57:31.083Z</updated>
    
    <content type="html"><![CDATA[<p>一个项目，整合Java企业级开发必须技能：选型考量、开发工具（IDEA）、版本管理（GIT）、持续构建（CI）、单元测试（JUNIT）、重构（Refactoring）、设计模式（Design Pattern）、并发编程…一个都不能少。全面超越老版尚学堂坦克大战！您可以通过限量折扣码<a href="https://www.udemy.com/course/java-tank-war/?couponCode=FREE-MAR20" target="_blank" rel="noopener"><strong>FREE-MAR20</strong></a>免费获取完整课程内容，或通过折扣码<a href="https://www.udemy.com/course/java-tank-war/?couponCode=JAVANEVERSLEEP-MAR20" target="_blank" rel="noopener"><strong>JAVANEVERSLEEP-MAR20</strong></a>享受七折优惠。</p><p><a href="https://www.udemy.com/course/java-tank-war/?couponCode=JAVANEVERSLEEP-MAR20" target="_blank" rel="noopener"><img src="https://www.dropbox.com/s/c40u990645zw8lx/Show_Me_The_Code.jpg?dl=1" alt=""></a><a id="more"></a></p><p>通过本课程您可以学习、了解：</p><ul><li>Java开发业界最佳实践</li><li>如何编写清晰、简洁、高效代码</li><li>熟练使用Maven构建工具</li><li>熟练应用重构手法和单元测试</li><li>独立设计、规划、开发中小型规模项目</li><li>了解开发环境、测试自动化流程</li></ul><h2 id="Section-1-热身赛"><a href="#Section-1-热身赛" class="headerlink" title="Section 1: 热身赛"></a>Section 1: 热身赛</h2><ol><li><p>JDK、开发工具，如何选？<br>选择JDK、开发工具简单吗？不简单！我们不做印象派，我们通过客观的数据和调查结果来作出最为理性、稳妥的选择，与此同时，我们也在个人研究、学习中勇于尝试新鲜事物，为未来的选择做好准备。</p></li><li><p>开发环境搭建，怎么自动化？<br>复杂开发环境的搭建、自动化开发环境搭建，告别刀耕火种，不再点击狂魔。</p></li><li><p>放码过来：热身<br>我们从一个简单的寻找最大、最小数字程序开始起步，介绍两种测试方法，并说明可改进之处。</p></li><li><p>放码过来：初探单元测试<br>我们开始一个稍有难度的程序编写，并初步介绍如何使用JUNIT5来测试我们的代码，与此同时，我们也衡量我们代码的单元测试覆盖率。</p></li><li><p>放码过来：为牛正名<br>我们尝试编写一个稍有难度的程序：USACO上面的一个练习，为牛正名。</p></li><li><p>放码过来：为牛正名继续改进<br>我们观察如何不断改进我们的程序，以及如何评估改动的代价和回报，我们也能看到面对意外，老司机不小心翻车之后如何及时找到Bug并解决。</p></li><li><p>放码过来：为牛正名补充说明<br>关于文件写入操作，flush以及try with resources的补充说明。</p></li></ol><h2 id="Section-2-坦克大战"><a href="#Section-2-坦克大战" class="headerlink" title="Section 2: 坦克大战"></a>Section 2: 坦克大战</h2><ol><li><p>新版新版，新在何处？<br>开门见山，我们对比广为流传的尚学堂马士兵老师版本，说明这一版本新在何处。</p></li><li><p>以终为始：项目演示<br>Begin with end in mind。我们先了解目标和终点，再回到起点开始。</p></li><li><p>分而治之：项目规划<br>我们以尽可能最简化的方式去规划项目，不引入不必要的复杂度和管理成本。</p></li><li><p>创建项目Repository并进行版本管理<br>使用Github创建repository，版本管理让我们有备无患，安心上路。</p></li><li><p>警惕拼写错误类Bug！<br>不小心打错一个字母引发的悲剧，如何避免此类悲剧重演？我们需要在方法论层面进行思考和改进。</p></li><li><p>移动坦克：上下左右</p></li><li><p>移动坦克：八个方向</p></li><li><p>加入敌方坦克</p></li><li><p>加入围墙</p></li><li><p>添加第一个单元测试</p></li><li><p>加入碰撞检测</p></li><li><p>Ready？Fire！让坦克可以开火</p></li><li><p>开火怎能没有声音？</p></li><li><p>超级发射！八个方向！</p></li><li><p>重构方向枚举类</p></li><li><p>重构移动方法</p></li><li><p>子弹与围墙、坦克的交互</p></li><li><p>敌方坦克团灭之后就地复活</p></li><li><p>加入爆炸图片、声音效果</p></li><li><p>实现Game Over和Restart</p></li><li><p>加入游戏得分显示</p></li><li><p>加入两棵树、宠物骆驼和急救包</p></li><li><p>关于存档功能的设计</p></li><li><p>基于FastJSON实现存档功能</p></li><li><p>使用位运算简化方向判定<br>一个数字，八个方向，清清爽爽，优雅简洁。使用四个甚至更多状态变量来切换的痛苦和纠结，不会再有了。</p></li><li><p>集成Travis和CodeCov<br>构建、运行测试永不打盹永不睡觉！这是工作方式调整的一小步，却是项目质量提高改进的一大步。</p></li><li><p>使用exe4j生成Windows可执行文件<br>提高用户体验第一步：可执行文件。</p></li><li><p>使用install4j生成Windows安装包文件<br>提高用户体验第二步：傻瓜安装包。带着对小白用户的深情厚爱，我们用心点下Build按钮。</p></li></ol><h2 id="Section-3-总结复盘"><a href="#Section-3-总结复盘" class="headerlink" title="Section 3 总结复盘"></a>Section 3 总结复盘</h2><ol><li><p>总结与新的开始：力扣超人！<br>我SHOW了我的CODE，现在，轮到您来SHOW了：寻找力扣周赛中的超人们。</p></li><li><p>致谢与鼓励  </p><blockquote><p>Not everyone can be a great programmer,<br>but everyone can be a programmer,<br>and make a difference!</p><p>Now it’s your time to make a difference.</p></blockquote></li></ol><script type="text/javascript">amzn_assoc_placement = "adunit0";amzn_assoc_search_bar = "true";amzn_assoc_tracking_id = "javaneversleep-20";amzn_assoc_ad_mode = "manual";amzn_assoc_ad_type = "smart";amzn_assoc_marketplace = "amazon";amzn_assoc_region = "US";amzn_assoc_title = "";amzn_assoc_linkid = "7006aa2cdd12ccf1fc87222b384c9e00";amzn_assoc_asins = "B01NBEQCA1,0596517335,0201485672,1787285731";</script><script src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US"></script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;一个项目，整合Java企业级开发必须技能：选型考量、开发工具（IDEA）、版本管理（GIT）、持续构建（CI）、单元测试（JUNIT）、重构（Refactoring）、设计模式（Design Pattern）、并发编程…一个都不能少。全面超越老版尚学堂坦克大战！您可以通过限量折扣码&lt;a href=&quot;https://www.udemy.com/course/java-tank-war/?couponCode=FREE-MAR20&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;strong&gt;FREE-MAR20&lt;/strong&gt;&lt;/a&gt;免费获取完整课程内容，或通过折扣码&lt;a href=&quot;https://www.udemy.com/course/java-tank-war/?couponCode=JAVANEVERSLEEP-MAR20&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;strong&gt;JAVANEVERSLEEP-MAR20&lt;/strong&gt;&lt;/a&gt;享受七折优惠。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.udemy.com/course/java-tank-war/?couponCode=JAVANEVERSLEEP-MAR20&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;img src=&quot;https://www.dropbox.com/s/c40u990645zw8lx/Show_Me_The_Code.jpg?dl=1&quot; alt=&quot;&quot;&gt;&lt;/a&gt;
    
    </summary>
    
      <category term="Udemy教程" scheme="http://www.javaneversleep.com/categories/Udemy%E6%95%99%E7%A8%8B/"/>
    
    
      <category term="Udemy" scheme="http://www.javaneversleep.com/tags/Udemy/"/>
    
  </entry>
  
  <entry>
    <title>“放码过来！作个Java实战派”Udemy良心课程免费放送！</title>
    <link href="http://www.javaneversleep.com/Udemy-Free-Course-Show-Me-the-Code-Java-Warrior-Part-I-Released/"/>
    <id>http://www.javaneversleep.com/Udemy-Free-Course-Show-Me-the-Code-Java-Warrior-Part-I-Released/</id>
    <published>2019-06-10T16:19:36.000Z</published>
    <updated>2020-03-17T23:22:01.741Z</updated>
    
    <content type="html"><![CDATA[<p>昨天，我把<a href="https://www.udemy.com/java-warrior-part1/" target="_blank" rel="noopener">“放码过来！作个Java实战派”</a>课程在Udemy上面设为永久免费，也将对应课程放到了YouTube对应频道<a href="https://www.youtube.com/channel/UClFNjZxKXLa8LpBj2m4PCDg?view_as=subscriber" target="_blank" rel="noopener">Java Never Sleep</a>，欢迎访问和订阅！这是一款深度广度胜过N多收费课程的良心课程，您要觉得我在自吹自擂，请听我细细道来。</p><p><a href="https://www.udemy.com/java-warrior-part1/" target="_blank" rel="noopener"><img src="https://www.dropbox.com/s/qlfnts6w47dz19e/java-warrior-part1.jpg?dl=1" alt=""></a><a id="more"></a></p><p>这门课程的特点在于并不追求所有知识点的完整罗列，而是基于28原则，集中发力于最常用的工作技能，并对部分内容进行深入展开。辅以高强度的编程练习，覆盖其他需要的知识点。</p><p>比如当我阐述面向对象概念时，我并不直接引入复杂概念，而是先从一个小游戏开始：</p><div class="video-container"><iframe src="//www.youtube.com/embed/0UH27zLzSJA" frameborder="0" allowfullscreen></iframe></div><p>比如我在讲解常用数据结构时，从一个待解决的问题“双城记词频统计问题”入手，逐个引入不同集合，并说明其使用场景。最后，我对集合类库进行完整的梳理，通过实时生成的类图对其结构一览无余。</p><p>以序章为例，恐怕我是极少数直接使用JShell进行Hello World讲解的特例，实际上，从JDK9引入JShell之后，很多人对这一工具所带来的便利还有基本认识。所以，在“首次Hello World”中，其安排是这样的：</p><blockquote><p>终于，我们开始安装JDK(12.0.1)、编写Hello World。在JDK12中，我们优先通过JShell运行Hello World，当然，我们也介绍古典Hello World的编写、编译、运行三部曲。</p></blockquote><p>然后为了说明以JVM为核心的Java生态系统思想，我对Hello World也进行了再次跟进，甚至包括一个基于Kotlin的Hello World。</p><blockquote><p>我们继续Hello World：我们介绍手工编译运行时需要注意的细节、自JDK 11之后引入的直接运行Single Source、在其他操作系统上运行Hello World、用JVM系编程语言之一的Kotlin来Hello World、用Eclipse编译器来Hello World。一沙一世界，我们后面还要三番四次Hello World，因为它绝不如大家看到、想象的那般简单。</p></blockquote><p>好了，Talk is Cheap，您前去观看，自有分晓。如果您对这款课程有任何疑问或反馈意见，都可以通过本站各种联系方式骚扰我。如果您觉得课程不错，记得给我来个好评😅</p><p>此外，我在Udemy上面也发布了一款项目开发驱动的课程<a href="https://www.udemy.com/java-tank-war/?couponCode=JAVANEVERSLEEP" target="_blank" rel="noopener">“放码过来！新版Java坦克大战”</a>，您可以通过折扣码<strong>JAVANEVERSLEEP</strong>享受限时2折优惠，别错过时间了哈😁</p><p><a href="https://www.udemy.com/java-tank-war/?couponCode=JAVANEVERSLEEP" target="_blank" rel="noopener"><img src="https://www.dropbox.com/s/c40u990645zw8lx/Show_Me_The_Code.jpg?dl=1" alt=""></a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;昨天，我把&lt;a href=&quot;https://www.udemy.com/java-warrior-part1/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;“放码过来！作个Java实战派”&lt;/a&gt;课程在Udemy上面设为永久免费，也将对应课程放到了YouTube对应频道&lt;a href=&quot;https://www.youtube.com/channel/UClFNjZxKXLa8LpBj2m4PCDg?view_as=subscriber&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Java Never Sleep&lt;/a&gt;，欢迎访问和订阅！这是一款深度广度胜过N多收费课程的良心课程，您要觉得我在自吹自擂，请听我细细道来。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.udemy.com/java-warrior-part1/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;img src=&quot;https://www.dropbox.com/s/qlfnts6w47dz19e/java-warrior-part1.jpg?dl=1&quot; alt=&quot;&quot;&gt;&lt;/a&gt;
    
    </summary>
    
      <category term="Udemy教程" scheme="http://www.javaneversleep.com/categories/Udemy%E6%95%99%E7%A8%8B/"/>
    
    
      <category term="Udemy" scheme="http://www.javaneversleep.com/tags/Udemy/"/>
    
  </entry>
  
  <entry>
    <title>My First Udemy Course: Tank War in Java Published!</title>
    <link href="http://www.javaneversleep.com/First-Udemy-Course-Tank-War-in-Java-Published/"/>
    <id>http://www.javaneversleep.com/First-Udemy-Course-Tank-War-in-Java-Published/</id>
    <published>2019-04-23T18:20:34.000Z</published>
    <updated>2020-03-17T23:22:01.737Z</updated>
    
    <content type="html"><![CDATA[<p>Just published my first course <a href="https://www.udemy.com/java-tank-war" target="_blank" rel="noopener">“Show Me the Code! Tank War in Java”</a> in Udemy! It’s avaiable for free access till April 28 with coupon code <strong>EASTER2019</strong>. Wanna have a try, man?</p><p><img src="https://www.dropbox.com/s/c40u990645zw8lx/Show_Me_The_Code.jpg?dl=1" alt=""><a id="more"></a></p><p>It was approved and published at April 18. Till now there are 30 students enrolled via the free coupon, 2 Five-Star ratings were received. It’s not as good as I expected, but at least I made the first step as planned in the beginning of this year.</p><p>In the next post I will try to summarize the first quarter of my work and effort put into this course and the “Java Never Sleep” project.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Just published my first course &lt;a href=&quot;https://www.udemy.com/java-tank-war&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;“Show Me the Code! Tank War in Java”&lt;/a&gt; in Udemy! It’s avaiable for free access till April 28 with coupon code &lt;strong&gt;EASTER2019&lt;/strong&gt;. Wanna have a try, man?&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://www.dropbox.com/s/c40u990645zw8lx/Show_Me_The_Code.jpg?dl=1&quot; alt=&quot;&quot;&gt;
    
    </summary>
    
      <category term="Udemy" scheme="http://www.javaneversleep.com/categories/Udemy/"/>
    
    
      <category term="Udemy" scheme="http://www.javaneversleep.com/tags/Udemy/"/>
    
  </entry>
  
  <entry>
    <title>Setup MOOC OOP Java Development Environment</title>
    <link href="http://www.javaneversleep.com/How-to-Setup-MOOC-Development-Environment/"/>
    <id>http://www.javaneversleep.com/How-to-Setup-MOOC-Development-Environment/</id>
    <published>2019-02-15T21:24:22.000Z</published>
    <updated>2020-03-17T23:22:01.737Z</updated>
    
    <content type="html"><![CDATA[<p>MOOC by University of Helsinki was said to be good and was actually very good. If you are a Java beginner who is searching for well-organized exercises, it won’t disappoint you. Object-Oriented Programming with Java <a href="https://materiaalit.github.io/2013-oo-programming/part1/week-1/" target="_blank" rel="noopener">Part I</a> and <a href="https://materiaalit.github.io/2013-oo-programming/part2/week-7/" target="_blank" rel="noopener">Part II</a>. Register an account at <a href="https://tmc.mooc.fi/user/new" target="_blank" rel="noopener">Test My Code</a>. Set up the development environment. Finish all the exercises there. That’s all. </p><p><img src="https://www.dropbox.com/s/nem2jk0x8lldftv/dev-env.jpg?dl=1" alt=""><a id="more"></a></p><p>However, many beginners would have difficulty in setting up development environment, and there are also some things you need to pay attention to.</p><h3 id="IDE-Selection"><a href="#IDE-Selection" class="headerlink" title="IDE Selection"></a>IDE Selection</h3><p>I would highly recommend you install <a href="https://netbeans.org/downloads/8.2/" target="_blank" rel="noopener">NetBeans 8.2 Java SE</a> with TMC plugin for Part I exercises. You may also install <a href="http://update.testmycode.net/installers/tmc-netbeans_org_mooc/tmc-netbeans_org_mooc_tmcbeans-windows.exe" target="_blank" rel="noopener">TMC-Bundle version</a>. For Part II exercises I suggest you using <a href="https://www.jetbrains.com/idea/download/#section=windows" target="_blank" rel="noopener">Intellij IDEA Community Edition</a>.</p><p>You need to install JDK first before NetBeans, it’s recommended to choose <a href="https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html" target="_blank" rel="noopener">JDK8</a> or lower version for NetBeans installation. For IDEA, it’s not needed for installation but needed for development.</p><p>For IDEA, remember to set language level to 1.6 or lower in project structure settings, as the TMC server side compile your code as 1.6. Without doing so you would pass all unit tests locally but failed at server side if you use some features not available in 1.6.</p><p><img src="https://www.dropbox.com/s/17ow99boghx0bx6/javac-level-6.jpg?dl=1" alt=""></p><p>Check the NetBeans project file and you would know why.<br><img src="https://www.dropbox.com/s/gpr5a7t3qntiuqz/tmc-javac-source.jpg?dl=1" alt=""></p><p>Anytime you failed at server side, remember to check error details in submission page.</p><p><img src="https://www.dropbox.com/s/hd91qe7a6z0nvqr/tmc-server-error.jpg?dl=1" alt=""></p><h3 id="Using-Chocalatery"><a href="#Using-Chocalatery" class="headerlink" title="Using Chocalatery"></a>Using Chocalatery</h3><p>Run <code>cmd.exe</code> as administrator and copy paste commands in the below, it will automatically install NetBeans 8.2 Java SE and IDEA Community edition. It’s much faster, but if you don’t feel comfortable with command line, then simply download, and click, click, and click.</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@"<span class="variable">%SystemRoot%</span>\System32\WindowsPowerShell\v1.<span class="number">0</span>\powershell.exe" -NoProfile -InputFormat None -ExecutionPolicy Bypass -Command "iex ((New-Object System.<span class="built_in">Net</span>.WebClient).DownloadString('https://chocolatey.org/install.ps1'))" &amp;&amp; <span class="built_in">SET</span> "<span class="built_in">PATH</span>=<span class="variable">%PATH%</span>;<span class="variable">%ALLUSERSPROFILE%</span>\chocolatey\bin"</span><br><span class="line"></span><br><span class="line">cinst netbeans-jse intellijidea-community -y</span><br></pre></td></tr></table></figure><p>Follow <a href="https://github.com/UniversityHelsinkiTKTL/tmc-plugin-installation-guide/blob/master/TmcPluginInstallationGuide.md#installing-tmc-plugin-to-exsisting-netbeans-installation-do-this-in-paja" target="_blank" rel="noopener">instructions of plugin install</a> would do the job.</p><p>Since package <code>netbeans-jse</code> is dependent on <code>jdk8</code>, it will also install jdk8 automatically if it’s not available.</p><h3 id="Attention"><a href="#Attention" class="headerlink" title="Attention!"></a>Attention!</h3><p>Your NetBeans might not work as expected due to the selection of JDK version not supported. In that case, you need to edit the configuration file and change JDK home for NetBeans manually.</p><p><img src="https://www.dropbox.com/s/78nepyips1y113i/netbeans-jdk-home.jpg?dl=1" alt=""></p><p>You can access all projects in NetBeans at the same time and work on multiple projects easily, however in IDEA you can do one exercise at one time, and need to switch project then, as Part I exercise are usually small, it’s really a little bit painful to switch projects too frequently, you know, IDEA is awesome but a little bit slow and heavyweight.</p><p>Make sure you pass all local tests first, but this doesn’t mean you will pass server-side tests. For example, if you use <code>System.exit(0)</code> in your <code>main</code> method, you would fail at Server side - one of my students uses this and is very confusing why server-side failed.</p><p>Make sure your output is exactly the same as expected, it’s very strict, even some words are very simple, don’t type them directly, always Copy+Paste them to avoid spelling mistakes.</p><p>You can Click <code>Run -&gt; Test Project</code>, or right-click the project and choose <code>Test</code>, or click the TMC button <code>Run tests locally</code> to perform local tests.</p><p>I experienced Copy+Paste issue in NetBeans sometimes, the quickest workaround to resolve it is restarting NetBeans, you may find it’s necessary sometimes.</p><iframe src="//rcm-na.amazon-adsystem.com/e/cm?o=1&p=48&l=ur1&category=books&banner=0HX1M2P8DDZ20D689R82&f=ifr&linkID=61f529dfb8b35107c92efc29a2c3c8dc&t=javaneversleep-20&tracking_id=javaneversleep-20" width="728" height="90" scrolling="no" border="0" marginwidth="0" style="border:none;" frameborder="0"></iframe>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;MOOC by University of Helsinki was said to be good and was actually very good. If you are a Java beginner who is searching for well-organized exercises, it won’t disappoint you. Object-Oriented Programming with Java &lt;a href=&quot;https://materiaalit.github.io/2013-oo-programming/part1/week-1/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Part I&lt;/a&gt; and &lt;a href=&quot;https://materiaalit.github.io/2013-oo-programming/part2/week-7/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Part II&lt;/a&gt;. Register an account at &lt;a href=&quot;https://tmc.mooc.fi/user/new&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Test My Code&lt;/a&gt;. Set up the development environment. Finish all the exercises there. That’s all. &lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://www.dropbox.com/s/nem2jk0x8lldftv/dev-env.jpg?dl=1&quot; alt=&quot;&quot;&gt;
    
    </summary>
    
      <category term="Tips" scheme="http://www.javaneversleep.com/categories/Tips/"/>
    
    
      <category term="MOOC" scheme="http://www.javaneversleep.com/tags/MOOC/"/>
    
  </entry>
  
  <entry>
    <title>To See a World in a Grain of Sand: Once Again Hello World</title>
    <link href="http://www.javaneversleep.com/To-See-a-World-in-a-Grain-of-Sand-Once-Again-Hello-World/"/>
    <id>http://www.javaneversleep.com/To-See-a-World-in-a-Grain-of-Sand-Once-Again-Hello-World/</id>
    <published>2019-02-11T22:42:29.000Z</published>
    <updated>2020-03-17T23:22:01.739Z</updated>
    
    <content type="html"><![CDATA[<p>“To see a world in a grain of sand”, and we would probably see a world in the simplest “Hello World”, so here we go, once again we will say Hello to the World.</p><p><img src="https://www.dropbox.com/s/wt3j4nasvmqywnx/sand.jpg?dl=1" alt=""><a id="more"></a></p><p>I guess all of the Java courses, tutorials start from this famous Hello World program, and this is one of those very rare programs that I can write without IDE’s help:)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Hello World"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-Do-you-know-these-options-of-javac"><a href="#1-Do-you-know-these-options-of-javac" class="headerlink" title="1. Do you know these options of javac?"></a>1. Do you know these options of javac?</h3><p>After your first program was written you will execute the command below first to compile it, or you cannot run it.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac HelloWorld.java</span><br></pre></td></tr></table></figure><p>You would probably find that it’s not necessary to name the file “HelloWorld.java”, “Hello.java” also works. And <code>public class HelloWorld</code> also can be downgraded to <code>class HelloWorld</code>.</p><p>If you are curious enough to press <code>javac --help</code>, you will see a lot of options regarding the Java compiler, for example, we want to print Chinese edition “Hello World” and expect it apply exactly to JDK8 language level, with metadata of parameter names included in, it will look like this:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac -encoding UTF-8 -source 8 -target 8 -parameters Hello.java</span><br></pre></td></tr></table></figure><p>You’ve got JDK11 installed, but using the command above you are releasing class files using 1.8 features only. If you have written some stuff only available from JDK9 on you would find it cannot compile as expected.</p><h3 id="2-Basics-of-the-class-file"><a href="#2-Basics-of-the-class-file" class="headerlink" title="2. Basics of the class file"></a>2. Basics of the class file</h3><p>There is a whole chapter regarding the class file format in <a href="https://docs.oracle.com/javase/specs/jvms/se11/html/jvms-4.html" target="_blank" rel="noopener">Java Virtual Machine specification</a>, do you want to explore it a little bit?</p><p><img src="https://www.dropbox.com/s/9errys0hbfqcl0e/source-byte.jpg?dl=1" alt=""></p><p>You see the bytecodes(compiled with JDK11) start with a magical, mysterious “cafe babe” and following with a value of 55 and a lot of stuff would hurt your brain. Among them, “cafe babe” is the magic, 55 points to minor version, which is mapped to JDK11. Compared to read the awesome class file format, you can also use <code>javap</code> to retrieve information for that class file:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> You would use javap -h to see how many options you have</span><br><span class="line">javap -p -l -c -s -constants HelloWorld</span><br></pre></td></tr></table></figure><p>You will get things like this:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> </span>&#123;</span><br><span class="line">  HelloWorld();                                                                                        </span><br><span class="line">    descriptor: ()V                                                                                    </span><br><span class="line">    Code:                                                                                              </span><br><span class="line">       <span class="number">0</span>: aload_0                                                                                      </span><br><span class="line">       1: invokespecial #1                  // Method java/lang/Object."&lt;init&gt;":()V                    </span><br><span class="line">       <span class="number">4</span>: <span class="keyword">return</span>                                                                                       </span><br><span class="line">    LineNumberTable:                                                                                   </span><br><span class="line">      line <span class="number">1</span>: <span class="number">0</span>                                                                                        </span><br><span class="line">                                                                                                       </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(java.lang.String[])</span></span>;                                                         </span><br><span class="line">    descriptor: ([Ljava/lang/String;)V                                                                 </span><br><span class="line">    Code:                                                                                              </span><br><span class="line">       0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;        </span><br><span class="line">       3: ldc           #3                  // String Hello World                                      </span><br><span class="line">       5: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">       <span class="number">8</span>: <span class="keyword">return</span>                                                                                       </span><br><span class="line">    LineNumberTable:                                                                                   </span><br><span class="line">      line <span class="number">4</span>: <span class="number">0</span>                                                                                        </span><br><span class="line">      line <span class="number">5</span>: <span class="number">8</span>                                                                                        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>You can see that the instructions here are somewhat similar to the source code, with the mappings of line number of source code and instruction numbers, you might be wondering, can I restore the source from these bunches of stuff?</p><h3 id="3-De-Compilers"><a href="#3-De-Compilers" class="headerlink" title="3. De-Compilers"></a>3. De-Compilers</h3><p>Yes, you can. There are many decompilers, but some of them are outdated for nowadays usage, such as <a href="https://github.com/java-decompiler/jd-gui" target="_blank" rel="noopener">JD-GUI</a>, JAD and etc, they would not work well on class file compiled with latest JDK. You may still use them, but <a href="http://www.benf.org/other/cfr/" target="_blank" rel="noopener">CFR</a> would be more suitable.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> java -jar cfr-0.139.jar HelloWorld.class</span><br><span class="line">/*                                               </span><br><span class="line"> * Decompiled with CFR 0.139.</span><br><span class="line"> */                                              </span><br><span class="line">import java.io.PrintStream;                      </span><br><span class="line">                                                 </span><br><span class="line">class HelloWorld &#123;                               </span><br><span class="line">    HelloWorld() &#123;                               </span><br><span class="line">    &#125;                                            </span><br><span class="line">                                                 </span><br><span class="line">    public static void main(String[] arrstring) &#123;</span><br><span class="line">        System.out.println("Hello World");       </span><br><span class="line">    &#125;                                            </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>You might have found that there is a slight difference with the source code and the de-compiled code(constructor method added), actually, you might be surprised to see that sometimes the generated code seems to be modified upon the source code. However, many of them are optimization from JVM and usually gains performance improvement, comparing the difference is actually interesting and would give you many insights.</p><h3 id="4-How-can-a-final-variable-with-null-value-initialized-again"><a href="#4-How-can-a-final-variable-with-null-value-initialized-again" class="headerlink" title="4. How can a final variable with null value initialized again?"></a>4. How can a final variable with null value initialized again?</h3><p><code>System.out.println(&quot;Hello World&quot;)</code>, System is a class and out is one of its static attributes with the final modifier:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> PrintStream out = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure><p>Then the problem comes, why the hack <code>System.out.println(&quot;Hello World&quot;)</code> won’t throw the famous <code>NullPointerException</code>, according to the language specification, it seems that the final static variable out is impossible to be assigned to a valid value again, right?</p><p>Yes, it’s right in most of the cases if you don’t use the dirty reflection tricks and don’t introduce the <code>native</code> buddy.</p><p>If you just want to play around, you would do like this:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Field f = clazz.getDeclaredField(<span class="string">"out"</span>);</span><br><span class="line">Field modifiersField = Field.class.getDeclaredField(<span class="string">"modifiers"</span>);</span><br><span class="line">modifiersField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">modifiersField.setInt(f, f.getModifiers() &amp; ~Modifier.FINAL);</span><br></pre></td></tr></table></figure></p><p>However, this gonna don’t work for <code>System</code>, the actual secret is hidden in these lines of code in <code>System.java</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">registerNatives</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    registerNatives();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>As per the comments written above the method, “VM will invoke the initializeSystemClass method to complete the initialization for this class”, go to the method of <code>initializeSystemClass</code> and you will see these lines:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FileInputStream fdIn = <span class="keyword">new</span> FileInputStream(FileDescriptor.in);</span><br><span class="line">FileOutputStream fdOut = <span class="keyword">new</span> FileOutputStream(FileDescriptor.out);</span><br><span class="line">FileOutputStream fdErr = <span class="keyword">new</span> FileOutputStream(FileDescriptor.err);</span><br><span class="line">setIn0(<span class="keyword">new</span> BufferedInputStream(fdIn));</span><br><span class="line">setOut0(newPrintStream(fdOut, props.getProperty(<span class="string">"sun.stdout.encoding"</span>)));</span><br><span class="line">setErr0(newPrintStream(fdErr, props.getProperty(<span class="string">"sun.stderr.encoding"</span>)));</span><br></pre></td></tr></table></figure><p>And you will also see these 3 native methods to set <code>in</code> and <code>out</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">setIn0</span><span class="params">(InputStream in)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">setOut0</span><span class="params">(PrintStream out)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">setErr0</span><span class="params">(PrintStream err)</span></span>;</span><br></pre></td></tr></table></figure><p>So now you know that JVM does this stuff in OS level and “bypass” the <code>final</code> restriction, you would probably ask, where the hack is the OS level code that JVM will adapt with?</p><p>So here it is <code>System.c</code><a href="http://hg.openjdk.java.net/jdk/jdk11/file/dde7eaaa3ddc/src/java.base/share/native/libjava/System.c" target="_blank" rel="noopener">(JDK11 version)</a>.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_java_lang_System_registerNatives(JNIEnv *env, jclass cls)</span><br><span class="line">&#123;</span><br><span class="line">    (*env)-&gt;RegisterNatives(env, cls,</span><br><span class="line">                            methods, <span class="keyword">sizeof</span>(methods)/<span class="keyword">sizeof</span>(methods[<span class="number">0</span>]));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The following three functions implement setter methods for</span></span><br><span class="line"><span class="comment"> * java.lang.System.&#123;in, out, err&#125;. They are natively implemented</span></span><br><span class="line"><span class="comment"> * because they violate the semantics of the language (i.e. set final</span></span><br><span class="line"><span class="comment"> * variable).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_java_lang_System_setIn0(JNIEnv *env, jclass cla, jobject stream)</span><br><span class="line">&#123;</span><br><span class="line">    jfieldID fid =</span><br><span class="line">        (*env)-&gt;GetStaticFieldID(env,cla,<span class="string">"in"</span>,<span class="string">"Ljava/io/InputStream;"</span>);</span><br><span class="line">    <span class="keyword">if</span> (fid == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    (*env)-&gt;SetStaticObjectField(env,cla,fid,stream);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Here you find the back door in the comments, <em>“They are natively implemented because they violate the semantics of the language (i.e. set final variable)”</em>.</p><p>And then, you would find that it’s a really a long, long road. The journey will never stop.</p><h3 id="The-End-Stop-for-a-while"><a href="#The-End-Stop-for-a-while" class="headerlink" title="The End: Stop for a while"></a>The End: Stop for a while</h3><blockquote><p>“To see a world in a grain of sand<br>And a Heaven in a Wild Flower<br>Hold Infinity in the palm of your hand<br>And Eternity in an hour”</p></blockquote><p>If the simplest <code>HelloWorld</code> is just a grain of sand, surely there is a world within it, maybe you have said “Hello” to it numerous times, but it doesn’t mean that you have explored the world a little bit, maybe now it’s the time and explore in the world, while sand would get your hands dirty, flower doesn’t.</p><p><img src="https://www.dropbox.com/s/arc1xfgfo4vss5z/flower.jpg?dl=1" alt=""></p><script type="text/javascript">amzn_assoc_placement = "adunit0";amzn_assoc_search_bar = "false";amzn_assoc_tracking_id = "javaneversleep-20";amzn_assoc_ad_mode = "manual";amzn_assoc_ad_type = "smart";amzn_assoc_marketplace = "amazon";amzn_assoc_region = "US";amzn_assoc_title = "";amzn_assoc_linkid = "21372c4acfda2c9cbd0a2cb43850af13";amzn_assoc_asins = "B00K3NR6M4,1449358454,0134685997,0071350934";</script><script src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US"></script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;“To see a world in a grain of sand”, and we would probably see a world in the simplest “Hello World”, so here we go, once again we will say Hello to the World.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://www.dropbox.com/s/wt3j4nasvmqywnx/sand.jpg?dl=1&quot; alt=&quot;&quot;&gt;
    
    </summary>
    
      <category term="Exploration of Java" scheme="http://www.javaneversleep.com/categories/Exploration-of-Java/"/>
    
    
      <category term="Exploration" scheme="http://www.javaneversleep.com/tags/Exploration/"/>
    
  </entry>
  
  <entry>
    <title>A Simple Approach to Simulate User Input and Check Output</title>
    <link href="http://www.javaneversleep.com/A-Simple-Approach-to-Simulate-User-Input-and-Check-Output/"/>
    <id>http://www.javaneversleep.com/A-Simple-Approach-to-Simulate-User-Input-and-Check-Output/</id>
    <published>2019-02-08T00:53:12.000Z</published>
    <updated>2020-03-17T23:22:01.729Z</updated>
    
    <content type="html"><![CDATA[<p>Recently some of my students asked me about the mechanism of unit test provided by MOOC from University of Helsinki, I checked their implementation and think it would be helpful for beginners to understand what happened actually, so this little article was posted.</p><p><img src="https://www.dropbox.com/s/5urgnayz9nch7ca/kick.jpg?dl=1" alt=""><a id="more"></a></p><p>We will use the project <a href="https://materiaalit.github.io/2013-oo-programming/part2/week-7/" target="_blank" rel="noopener">“Airport”</a> as an example, it’s the last assignment in the first week of OOP2.</p><p>We focus on test only, so I will skip things regarding how to resolve it. For this exercise, we would execute the <code>main</code> method manually each time, input plane id, capacity repeatedly, after sometime we think our code would work, we run local tests so that we can submit to server for online judge and grading.</p><p>I’ve been using this little project as an example on refactoring with the help of protection of unit test. When I input plane id, capacity number, airport code and operation code repeatedly and also painfully, I asked my students, “is this painful or not?”.</p><p>Obviously all of them answered yes. Then I asked, “will you make this kind of test again and again even it’s boring and painful?”.</p><p>Silence.</p><p>From my past experience I know that it’s easy to skip these boring tests and we can comfort ourselves, “these code are pretty simple and I cannot make a mistake, it will work and would work, don’t worry.”</p><p>I have painful memories because of such choices, because I’ve made too many simple and stupid mistakes in the past, so no matter how simple it looks, I would still make test - even it’s mannual test, boring and painful.</p><p>I added this because unit test cannot replace manual test completely, though it will make manual test easier and more effective.</p><p>For the Airport project, if we don’t need to input repeatedly each time, and we can capture the output of our program, compared to what is expected, we will get feedback much faster.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String operation = scanner.nextLine();</span><br><span class="line">...</span><br><span class="line">System.out.println(<span class="string">"Blahblahblah..."</span>);</span><br></pre></td></tr></table></figure><p>For example, we know exactly if we input <code>x</code> first, then it will go the Flight Service part and print the menu choices, if we input <code>x</code> for the second time then the program will end the loop and quit, as a result, we will only get output of instructions of Airport Panel and Flight Service.</p><p>So let’s go to a test case to see what will happen actually.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printsMenusAndExits</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    String syote = <span class="string">"x\nx\n"</span>;</span><br><span class="line">    MockInOut io = <span class="keyword">new</span> MockInOut(syote);</span><br><span class="line">    suorita(f(syote));</span><br><span class="line"></span><br><span class="line">    String[] menuRivit = &#123;</span><br><span class="line">        <span class="string">"Airport panel"</span>,</span><br><span class="line">        <span class="string">"[1] Add airplane"</span>,</span><br><span class="line">        <span class="string">"[2] Add flight"</span>,</span><br><span class="line">        <span class="string">"[x] Exit"</span>,</span><br><span class="line">        <span class="string">"Flight service"</span>,</span><br><span class="line">        <span class="string">"[1] Print planes"</span>,</span><br><span class="line">        <span class="string">"[2] Print flights"</span>,</span><br><span class="line">        <span class="string">"[3] Print plane info"</span>,</span><br><span class="line">        <span class="string">"[x] Quit"</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    String output = io.getOutput();</span><br><span class="line">    String op = output;</span><br><span class="line">    <span class="keyword">for</span> (String menuRivi : menuRivit) &#123;</span><br><span class="line">        <span class="keyword">int</span> ind = op.indexOf(menuRivi);</span><br><span class="line">        assertRight(menuRivi, syote, output, ind &gt; -<span class="number">1</span>);</span><br><span class="line">        op = op.substring(ind + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Above is the 2nd test case, which covers the most simple scenario as we said, input two <code>x</code> only.</p><p>When we look into the test code, it was splitted into 3 parts:</p><ul><li>Prepare input</li><li>execute <code>Main.main(args)</code> method</li><li>Check output to see if it contains all expected lines in sequence</li></ul><p>You know that the normal behavior of <code>scanner.nextLine()</code> or <code>scanner.nextInt()</code>. The program will hang on and wait for user’s input, so that the next line of code will be executed. But why here it just runs smoothly without any wait?</p><p>Before we go to this part I want to explain briefly regarding the execution of the method, it employs Java Reflection to invoke the method in a way not straightforward, but possible to make more check, for example, the first test case requires that <code>Main</code> is a public class, but you would probably find that to pass manual test, you can set <code>Main</code> access level to package.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">classIsPublic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    assertTrue(<span class="string">"Class "</span> + klassName + <span class="string">" should be public, so it must be defined as\n"</span> +</span><br><span class="line">        <span class="string">"public class "</span> + klassName + <span class="string">" &#123;...\n&#125;"</span>, klass.isPublic());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Here <code>klass.isPublic()</code> is checking whether you set access level as required.</p><p>OK. It seems that the class <a href="https://github.com/testmycode/edu-test-utils/blob/master/src/main/java/fi/helsinki/cs/tmc/edutestutils/MockInOut.java" target="_blank" rel="noopener"><code>MockInOut</code></a> makes magic happen, we can check the code to find the idea under the hood. You can access the source code at <a href="https://github.com/testmycode/edu-test-utils" target="_blank" rel="noopener">GitHub</a>.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">MockInOut</span><span class="params">(String input)</span> </span>&#123;</span><br><span class="line">    orig = System.out;</span><br><span class="line">    irig = System.in;</span><br><span class="line"></span><br><span class="line">    os = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        System.setOut(<span class="keyword">new</span> PrintStream(os, <span class="keyword">false</span>, charset.name()));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (UnsupportedEncodingException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    is = <span class="keyword">new</span> ByteArrayInputStream(input.getBytes());</span><br><span class="line">    System.setIn(is);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>You might have been typing <code>System.out</code> thousands of times, but did you realize that you can change the <code>out</code> silently like above? Here it set both <code>out</code> and <code>in</code> of System, so that we can get the output completely after execution, and we don’t need to input manually this time, because in the statement of<code>Scanner scanner = new Scanner(System.in);</code>, the parameter <code>System.in</code> is changed silently, so that <code>scanner.nextLine()</code> will get prepared input without hang on.</p><p>Also the output will not be printed in console, but accumulated into the <code>ByteArrayOutputStream</code>, which can be accessed afterwards.</p><p>You might be wondering that if we really want to restore the normal behavior of <code>System.in</code> and <code>System.out</code>, what shall we do?</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Restores System.in and System.out</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    os = <span class="keyword">null</span>;</span><br><span class="line">    is = <span class="keyword">null</span>;</span><br><span class="line">    System.setOut(orig);</span><br><span class="line">    System.setIn(irig);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Basically it saves original <code>in</code> and <code>out</code>, when a restoration is needed, simply clear the hacked ones and set them back, then all will be as usual again.</p><p>You can copy the simple sample code in the below for a quick test.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        PrintStream orig = System.out;</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream os = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        System.setOut(<span class="keyword">new</span> PrintStream(os, <span class="keyword">false</span>, <span class="string">"UTF-8"</span>));</span><br><span class="line">        <span class="comment">// Here it won't print but just accumulate</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Hello World"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.setOut(orig);</span><br><span class="line">        <span class="comment">// Print 100 lines of "Hello World" here since out was restored</span></span><br><span class="line">        System.out.println(os.toString(<span class="string">"UTF-8"</span>));</span><br><span class="line"></span><br><span class="line">        InputStream is = System.in;</span><br><span class="line">        System.setIn(<span class="keyword">new</span> ByteArrayInputStream(<span class="string">"x\nx\n"</span>.getBytes()));</span><br><span class="line">        Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        <span class="comment">// Without hang on</span></span><br><span class="line">        System.out.println(scanner.nextLine());</span><br><span class="line">        System.out.println(scanner.nextLine());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// There are only two lines provided, so here will fail</span></span><br><span class="line">            System.out.println(scanner.nextLine());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchElementException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.setIn(is);</span><br><span class="line">        scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        <span class="comment">// Hang on here since `in` was restored</span></span><br><span class="line">        System.out.println(scanner.nextLine());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Actually, inject and replace is a frequently used method to decouple dependencies for unit tests, which is quite useful to focus on your code only. There are more advanced and complex approaches to do this, but here we just want to explain a simple approach that “hack” <code>in</code> and <code>out</code> so that you can focus on your code, rather than the <code>in</code> and <code>out</code>.</p><p>For some legacy projects, this method might be critical for refactoring, as there are too many heavy dependencies make test really hard! There is a very good book covering this topic, which I read 8 years ago and found it’s very useful.</p><p><a target="blank" href="https://www.amazon.com/Working-Effectively-Legacy-Michael-Feathers/dp/0131177052/ref=as_li_ss_il?ie=UTF8&qid=1549590973&sr=8-1&keywords=working+with+legacy+code&linkCode=li3&tag=javaneversleep-20&linkId=49a9545f458b5002d5b0b74e3e6a1cb2&language=en_US"><img border="0" src="//ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&ASIN=0131177052&Format=_SL250_&ID=AsinImage&MarketPlace=US&ServiceVersion=20070822&WS=1&tag=javaneversleep-20&language=en_US"></a><img src="https://ir-na.amazon-adsystem.com/e/ir?t=javaneversleep-20&language=en_US&l=li3&o=1&a=0131177052" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"></p><iframe src="//rcm-na.amazon-adsystem.com/e/cm?o=1&p=48&l=ur1&category=prime_student&banner=0MBMTG021FA4HVT1NWG2&f=ifr&linkID=a65bd167cffd233cd211f56ff82069c2&t=javaneversleep-20&tracking_id=javaneversleep-20" width="728" height="90" scrolling="no" border="0" marginwidth="0" style="border:none;" frameborder="0"></iframe>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Recently some of my students asked me about the mechanism of unit test provided by MOOC from University of Helsinki, I checked their implementation and think it would be helpful for beginners to understand what happened actually, so this little article was posted.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://www.dropbox.com/s/5urgnayz9nch7ca/kick.jpg?dl=1&quot; alt=&quot;&quot;&gt;
    
    </summary>
    
      <category term="Tips" scheme="http://www.javaneversleep.com/categories/Tips/"/>
    
    
      <category term="Tips" scheme="http://www.javaneversleep.com/tags/Tips/"/>
    
  </entry>
  
  <entry>
    <title>Yet Another 10 Books For Java Learners - Part II</title>
    <link href="http://www.javaneversleep.com/Yet-Another-Top-10-Books-For-Java-Learners-Part-II/"/>
    <id>http://www.javaneversleep.com/Yet-Another-Top-10-Books-For-Java-Learners-Part-II/</id>
    <published>2019-02-07T19:22:35.000Z</published>
    <updated>2020-03-17T23:22:01.741Z</updated>
    
    <content type="html"><![CDATA[<p>In the last post I introduced 5 “books” from beginner to intermediate, this time I’d like to add more stuff. Beware, they would hurt your brain permanently, take care and be prepared!</p><p><img src="https://www.dropbox.com/s/34zve76kng5cagf/brain-hurt.jpg?dl=1" alt=""><a id="more"></a></p><h2 id="No-6-Algorithms-4th-Edition"><a href="#No-6-Algorithms-4th-Edition" class="headerlink" title="No.6 Algorithms 4th Edition"></a>No.6 <a href="https://amzn.to/2HZhkEv" target="_blank" rel="noopener">Algorithms 4th Edition</a></h2><p>I recommend this book to you so that I can hurt you as I’ve been hurt, possibly permanently:) The good thing is that all the algorithms introduced in this book provide Java implementations. You can even access them in <a href="https://github.com/kevin-wayne/algs4" target="_blank" rel="noopener">GitHub</a>. There is also an open online course there for free, which I’ve been enrolled in and struggling with the assignments. <a href="https://www.coursera.org/learn/algorithms-part1" target="_blank" rel="noopener">Algorithms, Part I</a> and <a href="https://www.coursera.org/learn/algorithms-part2" target="_blank" rel="noopener">Algorithms, Part II</a> are definitely awesome and would help you a lot besides reading the book.</p><p>I know that programmers have different opinions against algorithms, some said this kind of stuff was rarely used in their daily work, some said that it’s super important - at least for interviews. I leave the answer to you and IMHO it’s up to you and only up to you. Life is short, learn what you want and love first, and learn some stuff later if needed. However, if you still have much time available, then just jump into this deep ocean and, ENJOY!</p><p><a target="blank" href="https://www.amazon.com/Algorithms-4th-Robert-Sedgewick/dp/032157351X/ref=as_li_ss_il?ie=UTF8&linkCode=li3&tag=javaneversleep-20&linkId=1858b34ad2c5016ce136cafefbeb02b6&language=en_US"><img border="0" src="//ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&ASIN=032157351X&Format=_SL250_&ID=AsinImage&MarketPlace=US&ServiceVersion=20070822&WS=1&tag=javaneversleep-20&language=en_US"></a><img src="https://ir-na.amazon-adsystem.com/e/ir?t=javaneversleep-20&language=en_US&l=li3&o=1&a=032157351X" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"></p><p>If sometimes you are doubtful regarding the value of this learning process, read the scripts in the below of a movie - a real movie.</p><p><img src="https://www.dropbox.com/s/r3y3zzi7pyzk5oi/red-black-tree.jpg?dl=1" alt=""></p><p>And ask yourself, “Does that help you with ladies?”. For me, I want to ask Professor Robert Sedgwick this question also, as he is one of the inventors of Red-Black-Tree. The inventor himself explain the data structure and algorithms to you, really exciting, right?</p><p>Last but not least, if you got stuck and depressed, come here and check my painful submission history - just one of them, and you will find that you are not alone, and you will never walk alone.</p><p><img src="https://www.dropbox.com/s/s4wqfu5x0vbi6cj/week3-submission.PNG?dl=1" alt=""></p><h2 id="No-7-Introduction-to-Algorithms-3rd-Edition-The-MIT-Press"><a href="#No-7-Introduction-to-Algorithms-3rd-Edition-The-MIT-Press" class="headerlink" title="No.7 Introduction to Algorithms, 3rd Edition (The MIT Press)"></a>No.7 <a href="https://amzn.to/2MUfFix" target="_blank" rel="noopener">Introduction to Algorithms, 3rd Edition (The MIT Press)</a></h2><p>So the journey of brain hurt continues. Algorithms 4th edition is good enough, but surprisingly it doesn’t cover some important topics such as Dynamic Programming, I don’t know why but I know that many programmers have the same feeling. This book from MIT covered that and more than that, some even said that it’s better than Knuth’s Art of Programming series, as they are relatively too old and outdated. I’m not able to give any comment on this opinion, I just want to tell you that till now I never touched Knuth’s books, and so I won’t recommend them to you, even though they are said to be super good.</p><p><a target="blank" href="https://www.amazon.com/Introduction-Algorithms-3rd-MIT-Press/dp/0262033844/ref=as_li_ss_il?_encoding=UTF8&psc=1&refRID=6N4K1BRSHR7QB3ZRJE8T&linkCode=li3&tag=javaneversleep-20&linkId=7d97e4e05fe59f8a538b47f36c88e369&language=en_US"><img border="0" src="//ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&ASIN=0262033844&Format=_SL250_&ID=AsinImage&MarketPlace=US&ServiceVersion=20070822&WS=1&tag=javaneversleep-20&language=en_US"></a><img src="https://ir-na.amazon-adsystem.com/e/ir?t=javaneversleep-20&language=en_US&l=li3&o=1&a=0262033844" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"></p><h2 id="No-8-The-Mythical-Man-Month"><a href="#No-8-The-Mythical-Man-Month" class="headerlink" title="No.8 The Mythical Man-Month"></a>No.8 <a href="https://amzn.to/2Ic5My7" target="_blank" rel="noopener">The Mythical Man-Month</a></h2><p>After two cold and cruel books on algorithms, I think it’s time to relax for a while. This book on software engineering will not hurt your brain that much - at least I didn’t. Take a cup of coffee and enjoy the reading, it’s thoughtful and also interesting.</p><p><a target="blank" href="https://www.amazon.com/Mythical-Man-Month-Software-Engineering-Anniversary/dp/0201835959/ref=as_li_ss_il?s=books&ie=UTF8&qid=1549569350&sr=1-1&keywords=The+Mythical+Man-Month:+E&linkCode=li3&tag=javaneversleep-20&linkId=d612640e2be88c4b11e01efc7409c96b&language=en_US"><img border="0" src="//ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&ASIN=0201835959&Format=_SL250_&ID=AsinImage&MarketPlace=US&ServiceVersion=20070822&WS=1&tag=javaneversleep-20&language=en_US"></a><img src="https://ir-na.amazon-adsystem.com/e/ir?t=javaneversleep-20&language=en_US&l=li3&o=1&a=0201835959" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"></p><h2 id="No-9-The-Java-Virtual-Machine-Specification-Java-SE-8-Edition"><a href="#No-9-The-Java-Virtual-Machine-Specification-Java-SE-8-Edition" class="headerlink" title="No.9 The Java Virtual Machine Specification, Java SE 8 Edition"></a>No.9 <a href="https://amzn.to/2MU7KSh" target="_blank" rel="noopener">The Java Virtual Machine Specification, Java SE 8 Edition</a></h2><p>You will be interested in how JVM works, right? If not then just skip to No.10. There are many books with title like “Inside Java Virtual Machine”, but I would say the specification is more definitive and accurate. You can even try to implement these specifications if you want and dare - I know someone learns C++ like this. It’s reasonable as JVM is implemented in C++, this kind of ridiculous learning style is really impressive, but I have to honestly admit that I just can’t.</p><p><a target="blank" href="https://www.amazon.com/Java-Virtual-Machine-Specification-Addison-Wesley/dp/013390590X/ref=as_li_ss_il?_encoding=UTF8&pd_rd_i=013390590X&pd_rd_r=d88b158a-2b12-11e9-a0e4-3bc27177701b&pd_rd_w=u55dS&pd_rd_wg=krTNP&pf_rd_p=588939de-d3f8-42f1-a3d8-d556eae5797d&pf_rd_r=2R56XKCGKV73R2M9F2NA&psc=1&refRID=2R56XKCGKV73R2M9F2NA&linkCode=li3&tag=javaneversleep-20&linkId=f377d1035aca56c9ff8e9d01a62c5908&language=en_US"><img border="0" src="//ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&ASIN=013390590X&Format=_SL250_&ID=AsinImage&MarketPlace=US&ServiceVersion=20070822&WS=1&tag=javaneversleep-20&language=en_US"></a><img src="https://ir-na.amazon-adsystem.com/e/ir?t=javaneversleep-20&language=en_US&l=li3&o=1&a=013390590X" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"></p><p>If you found this book is too boring to read, then stop immediately, the best time for you to read this book might not be fulfilled, however, please remember this book and come back later.</p><h2 id="No-10-GitHub-and-Awesome-Java"><a href="#No-10-GitHub-and-Awesome-Java" class="headerlink" title="No.10 GitHub and Awesome Java"></a>No.10 GitHub and <a href="https://github.com/akullpp/awesome-java" target="_blank" rel="noopener">Awesome Java</a></h2><p>Apparently, GitHub is not a book, but the most popular Java projects are out there and it’s really easy for you to learn the best practices from these awesome projects, or from some most popular projects. Since talk is cheap, being involved in some good projects will be even more important than just reading books.</p><p>There are many other good books, but I don’t want to pretend that I know all of them very well and make some general comments so that it won’t be wrong. IMHO it’s enough for you to read and practice even only one of them thoroughly, rather than just read and never put them into practice seriously.</p><p>Happy Reading and Happy Coding!</p><p>PS: <a href="https://www.javacodegeeks.com/learn-java-programming-online.html" target="_blank" rel="noopener">“Best Way to Learn Java Programming Online”</a> is a great article from Lefteris Karageorgiou of <a href="https://www.javacodegeeks.com/" target="_blank" rel="noopener">Java Code Geeks</a>. I put it here for your reference and hope you guys enjoy it.</p><iframe src="//rcm-na.amazon-adsystem.com/e/cm?o=1&p=48&l=ur1&category=books&banner=0HX1M2P8DDZ20D689R82&f=ifr&linkID=01919cf4a8b6a34712b260e3e75d5b48&t=javaneversleep-20&tracking_id=javaneversleep-20" width="728" height="90" scrolling="no" border="0" marginwidth="0" style="border:none;" frameborder="0"></iframe>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;In the last post I introduced 5 “books” from beginner to intermediate, this time I’d like to add more stuff. Beware, they would hurt your brain permanently, take care and be prepared!&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://www.dropbox.com/s/34zve76kng5cagf/brain-hurt.jpg?dl=1&quot; alt=&quot;&quot;&gt;
    
    </summary>
    
      <category term="Great Books" scheme="http://www.javaneversleep.com/categories/Great-Books/"/>
    
    
      <category term="Awesome Books" scheme="http://www.javaneversleep.com/tags/Awesome-Books/"/>
    
  </entry>
  
  <entry>
    <title>Yet Another 10 Books For Java Learners - Part I</title>
    <link href="http://www.javaneversleep.com/Yet-Another-Top-10-Books-For-Java-Learners/"/>
    <id>http://www.javaneversleep.com/Yet-Another-Top-10-Books-For-Java-Learners/</id>
    <published>2019-02-01T15:39:27.000Z</published>
    <updated>2020-03-17T23:22:01.742Z</updated>
    
    <content type="html"><![CDATA[<p>Honestly speaking, there is no need to post an article on the topic “Top 10 Books For Java Learners”, which is possibly older than your age. I do this for the 12 students I’m teaching Java programming language recently, I’d like to summarize a book list of 10 for their reference. I don’t want to recommend books said to be great but I never read, so some of the books listed here maybe not that famous or popular, but at least they are good to me and helped me a lot in the past.</p><p><img src="https://www.dropbox.com/s/6cir6bgtlzzl94j/books.jpg?dl=1" alt=""><a id="more"></a></p><h2 id="No-1-MOOC-By-University-of-Helsinki"><a href="#No-1-MOOC-By-University-of-Helsinki" class="headerlink" title="No.1 MOOC By University of Helsinki"></a>No.1 MOOC By University of Helsinki</h2><p>Yes, I’m joking and I’m not joking. From my own experience, I don’t think it’s the most efficient way to read a book systematically when you are pure beginners - especially if you never write code before. What you need to do is to understand the basic concepts quickly first, then <strong>JUST DO IT!</strong> Keep practicing, keep practicing and keep practicing.</p><p><a target="_blank" href="https://www.amazon.com/NIKE-Sportswear-Swoosh-Varsity-Medium/dp/B00TFAEPRA/ref=as_li_ss_il?keywords=JUST+DO+IT&qid=1567544203&s=gateway&sr=8-3&linkCode=li3&tag=javaneversleep-20&linkId=bffa1eed3eca14ed4620988ea55a9014"><img border="0" src="//ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&ASIN=B00TFAEPRA&Format=_SL250_&ID=AsinImage&MarketPlace=US&ServiceVersion=20070822&WS=1&tag=javaneversleep-20"></a><img src="https://ir-na.amazon-adsystem.com/e/ir?t=javaneversleep-20&l=li3&o=1&a=B00TFAEPRA" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"></p><p>Object-Oriented Programming with Java <a href="https://materiaalit.github.io/2013-oo-programming/part1/week-1/" target="_blank" rel="noopener">Part I</a> and <a href="https://materiaalit.github.io/2013-oo-programming/part2/week-7/" target="_blank" rel="noopener">Part II</a>. Register an account at <a href="https://tmc.mooc.fi/user/new" target="_blank" rel="noopener">Test My Code</a>. Finish all the exercises there. Post a screenshot to prove you really did it. That’s all.</p><p><img src="https://www.dropbox.com/s/fg5ceqyklz7x6wf/mooc-part1-109.jpg?dl=1" alt=""></p><p>Most of the students give positive feedback regarding the exercises. There is one Easter Egg in one of the test cases waiting for you to find there. Trust me, stick to the end and you won’t miss it.</p><p>Wait…but this is obviously not a book, right?</p><p>Yeah, right, but so what? For beginners, this would be the best resource for a quick start and get your hands dirty. Talk is cheap, show me the code!</p><p><a target="_blank" href="https://www.amazon.com/cheap-programming-developer-Pullover-Hoodie/dp/B07V7LVDMT/ref=as_li_ss_il?keywords=show+me+the+code&qid=1567544365&s=gateway&sr=8-5&linkCode=li3&tag=javaneversleep-20&linkId=e83252c46a8cf7de9c2489df7111fb1d"><img border="0" src="//ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&ASIN=B07V7LVDMT&Format=_SL250_&ID=AsinImage&MarketPlace=US&ServiceVersion=20070822&WS=1&tag=javaneversleep-20"></a><img src="https://ir-na.amazon-adsystem.com/e/ir?t=javaneversleep-20&l=li3&o=1&a=B07V7LVDMT" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"></p><h2 id="No-2-Refactoring-Improving-the-Design-of-Existing-Code"><a href="#No-2-Refactoring-Improving-the-Design-of-Existing-Code" class="headerlink" title="No.2 Refactoring: Improving the Design of Existing Code"></a>No.2 Refactoring: Improving the Design of Existing Code</h2><p>After you get your hands dirty for a long time and write enough code like shit, this book written by Martin Fowler is worthy to read thoroughly and practice the methods introduced one by one. <a href="https://amzn.to/2GeaV5Q" target="_blank" rel="noopener">Refactoring: Improving the Design of Existing Code</a> has two editions, though the <a href="https://amzn.to/2DOMhaE" target="_blank" rel="noopener">2nd Edition</a> is available with many updates, I would personally suggest you read the <a href="https://amzn.to/2MKnHKN" target="_blank" rel="noopener">1st Edition</a> since you are a Java learner.</p><p><a target="_blank" href="https://www.amazon.com/gp/product/0134757599/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=0134757599&linkCode=as2&tag=javaneversleep-20&linkId=89250f6bdc5dbc4ec626099edabefb8d"><img border="0" src="//ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&MarketPlace=US&ASIN=0134757599&ServiceVersion=20070822&ID=AsinImage&WS=1&Format=_SL250_&tag=javaneversleep-20"></a><img src="//ir-na.amazon-adsystem.com/e/ir?t=javaneversleep-20&l=am2&o=1&a=0134757599" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"></p><p>I always recommend this book to other programmers, as it had a great impact on my career. I was promoted to Team Leader in my first company because I finished refactoring against a module nobody wants to do - too painful and too brain-hurt. I found this book by chance in the bookshelf one afternoon, and I’m addicted to it and I just finished reading this book very quickly and used several methods there, and from that time on I began to write fully covered unit tests for my code, which made my life and our colleagues’ life much easier.</p><h2 id="No-3-Effective-Java"><a href="#No-3-Effective-Java" class="headerlink" title="No.3 Effective Java"></a>No.3 Effective Java</h2><p>Joshua Bloch, the guy who designed and implemented Java Collection Framework(of course not himself alone), released the <a href="https://amzn.to/2Ggl5D4" target="_blank" rel="noopener">3rd Edition</a> of this book. For me, I actually read the Chinese translation of the <a href="https://amzn.to/2S3qqoj" target="_blank" rel="noopener">2nd Edition</a>, which is very impressive. This is a book more like a master telling his experience, insights, best practices to you, rather than a textbook. This book, like its title, is really “Effective”.</p><p><a target="_blank" href="https://www.amazon.com/Effective-Java-Joshua-Bloch/dp/0134685997/ref=as_li_ss_il?ie=UTF8&qid=1549037913&sr=8-2&keywords=effective+java&linkCode=li3&tag=javaneversleep-20&linkId=fa9eefc833d196486daa8c9f8e92c294&language=en_US"><img border="0" src="//ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&ASIN=0134685997&Format=_SL250_&ID=AsinImage&MarketPlace=US&ServiceVersion=20070822&WS=1&tag=javaneversleep-20&language=en_US"></a><img src="https://ir-na.amazon-adsystem.com/e/ir?t=javaneversleep-20&language=en_US&l=li3&o=1&a=0134685997" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"></p><h2 id="No-4-Head-First-Design-Patterns"><a href="#No-4-Head-First-Design-Patterns" class="headerlink" title="No.4 Head First Design Patterns"></a>No.4 Head First Design Patterns</h2><p><a href="https://amzn.to/2WA1wvm" target="_blank" rel="noopener">“Design Patterns: Elements of Reusable Object-Oriented Software”</a> by GoF is said to be “Classic, Awesome…” and blahblah. However, I didn’t read this legendary book, because I am too low to enjoy another funny book: <a href="https://amzn.to/2MILzON" target="_blank" rel="noopener">Head First Design Patterns</a>. All the source code of this book can be accessed at <a href="https://github.com/bethrobson/Head-First-Design-Patterns" target="_blank" rel="noopener">GitHub</a>.</p><p><a target="_blank" href="https://www.amazon.com/Head-First-Design-Patterns-Brain-Friendly/dp/0596007124/ref=as_li_ss_il?ie=UTF8&qid=1549038335&sr=8-1&keywords=head+first+design+patterns+2014&linkCode=li3&tag=javaneversleep-20&linkId=bce55d8f6d7171449418836de9a8d2d6&language=en_US"><img border="0" src="//ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&ASIN=0596007124&Format=_SL250_&ID=AsinImage&MarketPlace=US&ServiceVersion=20070822&WS=1&tag=javaneversleep-20&language=en_US"></a><img src="https://ir-na.amazon-adsystem.com/e/ir?t=javaneversleep-20&language=en_US&l=li3&o=1&a=0596007124" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"></p><p>Life is short and I don’t want to waste too much time arguing which book is better or not. What I know is if you just want to read one book about Design Patterns in Java, then choose this one and you won’t regret.</p><h2 id="No-5-Clean-Code-A-Handbook-of-Agile-Software-Craftsmanship"><a href="#No-5-Clean-Code-A-Handbook-of-Agile-Software-Craftsmanship" class="headerlink" title="No.5 Clean Code: A Handbook of Agile Software Craftsmanship"></a>No.5 Clean Code: A Handbook of Agile Software Craftsmanship</h2><p><a href="https://amzn.to/2WCDZKn" target="_blank" rel="noopener">Clean Code</a> by Uncle Bob, IMHO, is not that practical and useful to me compared to the books listed above. But it’s a good summary and provides more information which can enhance you still, besides that, this book is very interesting and it’s a joyful read. When Uncle Bob said that he “turned on his old TV and tried to watch some scaring movies, but there is not even one ghost there. Sh.t!”, I just laughed to the ground. Anyway, for those who really care about quality, cleanness of your code, this book is a must-read.</p><p><a target="_blank" href="https://www.amazon.com/Clean-Code-Handbook-Software-Craftsmanship/dp/0132350882/ref=as_li_ss_il?ie=UTF8&qid=1549038518&sr=8-1&keywords=clean+code&linkCode=li3&tag=javaneversleep-20&linkId=586746e3093661bce05cf7b585646c25&language=en_US"><img border="0" src="//ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&ASIN=0132350882&Format=_SL250_&ID=AsinImage&MarketPlace=US&ServiceVersion=20070822&WS=1&tag=javaneversleep-20&language=en_US"></a><img src="https://ir-na.amazon-adsystem.com/e/ir?t=javaneversleep-20&language=en_US&l=li3&o=1&a=0132350882" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;"></p><p>PS: <a href="https://www.javacodegeeks.com/learn-java-programming-online.html" target="_blank" rel="noopener">“Best Way to Learn Java Programming Online”</a> is a great article from Lefteris Karageorgiou of <a href="https://www.javacodegeeks.com/" target="_blank" rel="noopener">Java Code Geeks</a>. I put it here for your reference and hope you guys enjoy it.</p><p><strong>-To Be Continued-</strong></p><script type="text/javascript">amzn_assoc_placement = "adunit0";amzn_assoc_search_bar = "true";amzn_assoc_tracking_id = "javaneversleep-20";amzn_assoc_ad_mode = "manual";amzn_assoc_ad_type = "smart";amzn_assoc_marketplace = "amazon";amzn_assoc_region = "US";amzn_assoc_title = "";amzn_assoc_linkid = "b2d7aa2b3289e841ea7dae7b785b8767";amzn_assoc_asins = "0201485672,0134685997,0596007124,0132350882";</script><script src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US"></script><iframe src="//rcm-na.amazon-adsystem.com/e/cm?o=1&p=48&l=ur1&category=books&banner=0HX1M2P8DDZ20D689R82&f=ifr&linkID=61f529dfb8b35107c92efc29a2c3c8dc&t=javaneversleep-20&tracking_id=javaneversleep-20" width="728" height="90" scrolling="no" border="0" marginwidth="0" style="border:none;" frameborder="0"></iframe>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Honestly speaking, there is no need to post an article on the topic “Top 10 Books For Java Learners”, which is possibly older than your age. I do this for the 12 students I’m teaching Java programming language recently, I’d like to summarize a book list of 10 for their reference. I don’t want to recommend books said to be great but I never read, so some of the books listed here maybe not that famous or popular, but at least they are good to me and helped me a lot in the past.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://www.dropbox.com/s/6cir6bgtlzzl94j/books.jpg?dl=1&quot; alt=&quot;&quot;&gt;
    
    </summary>
    
      <category term="Great Books" scheme="http://www.javaneversleep.com/categories/Great-Books/"/>
    
    
      <category term="Awesome Books" scheme="http://www.javaneversleep.com/tags/Awesome-Books/"/>
    
  </entry>
  
  <entry>
    <title>A Simple Tank War Game Exercise for Java Beginners</title>
    <link href="http://www.javaneversleep.com/A-Simple-Tank-War-Game-Exercise-for-Java-Beginners/"/>
    <id>http://www.javaneversleep.com/A-Simple-Tank-War-Game-Exercise-for-Java-Beginners/</id>
    <published>2019-01-25T21:38:38.000Z</published>
    <updated>2020-03-17T23:22:01.730Z</updated>
    
    <content type="html"><![CDATA[<p>I’ve just published a mid-term project for a small group of students. If you are a Java beginner who is seeking some challenge to conquer, I believe this <a href="https://github.com/nateyoung427/tankwar" target="_blank" rel="noopener">Tank War</a> game would be fit for you. Wanna a try?😄 Solution for your reference will be released after 3 weeks.</p><p><img src="https://www.dropbox.com/s/h7lb40jzzkcskun/tank-war.jpg?dl=1" alt=""><a id="more"></a></p><p>I wrote my first line of Java code, the awesome “Hello World” at 26. It was 2009 and life is really tough for me, all my hope is to finish the coding camp program as soon as possible and start working as a programmer to earn some livings. This little game was the final project of JavaSE course and I just cannot figure out it myself, only by following the instructor’s patient explanations I can catch up with what he is actually doing at that time. I don’t remember how many hours I spent on this little, stupid, and boring game, but I would never forget this painful experience.</p><p>And this time, when I told the students that they need to finish this in 3 weeks, half of them silenced, I know that feeling very well - they have no idea what to do, just like me 10 years ago. Maybe they don’t know, less than 450 lines of code will be sufficient for the implementations. Unreasonable fear would just make you ignoring many obvious and clear facts.</p><p>One would easily choose “Game Over”, and rarely press F2 to restart.</p><p><img src="https://www.dropbox.com/s/z1gars1msdvmsug/game-over.jpg?dl=1" alt=""></p><p>At that time, I was upset, depressed and anxious, but with patience and sweat, I finally finished the 3 months program and fortunately found a job to begin my career as a programmer. 10 years later, it has been very clear to me that I don’t have much talent in this area, but it doesn’t mean that I cannot leverage my skills to make a difference and help others - which I’ve actually done these years.</p><p>Yes, not everyone can be a great programmer, but everyone can be a programmer and make a difference - if they really want and devote themselves to it.</p><p>Set up a challenging goal, and achieve it by all means - I firmly believe this is the most efficient way to improve your programming skills. So do not fear, do not hesitate.</p><p>And, <strong>JUST DO IT!</strong></p><script type="text/javascript">amzn_assoc_placement = "adunit0";amzn_assoc_search_bar = "false";amzn_assoc_tracking_id = "oldyoungboy-20";amzn_assoc_ad_mode = "manual";amzn_assoc_ad_type = "smart";amzn_assoc_marketplace = "amazon";amzn_assoc_region = "US";amzn_assoc_title = "";amzn_assoc_linkid = "de429ade981a7c8fe5027e941b980ae1";amzn_assoc_asins = "B00TFAET2G,0134685997,0134757599,020161622X";</script><script src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US"></script><iframe src="//rcm-na.amazon-adsystem.com/e/cm?o=1&p=48&l=ur1&category=books&banner=0HX1M2P8DDZ20D689R82&f=ifr&linkID=61f529dfb8b35107c92efc29a2c3c8dc&t=javaneversleep-20&tracking_id=javaneversleep-20" width="728" height="90" scrolling="no" border="0" marginwidth="0" style="border:none;" frameborder="0"></iframe>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;I’ve just published a mid-term project for a small group of students. If you are a Java beginner who is seeking some challenge to conquer, I believe this &lt;a href=&quot;https://github.com/nateyoung427/tankwar&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Tank War&lt;/a&gt; game would be fit for you. Wanna a try?😄 Solution for your reference will be released after 3 weeks.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://www.dropbox.com/s/h7lb40jzzkcskun/tank-war.jpg?dl=1&quot; alt=&quot;&quot;&gt;
    
    </summary>
    
      <category term="Projects" scheme="http://www.javaneversleep.com/categories/Projects/"/>
    
    
      <category term="Tank War" scheme="http://www.javaneversleep.com/tags/Tank-War/"/>
    
  </entry>
  
  <entry>
    <title>7 Tips of Searching GitHub Repositories You Should Know</title>
    <link href="http://www.javaneversleep.com/7-Tips-of-Searching-Github-Repositories-You-Should-Know/"/>
    <id>http://www.javaneversleep.com/7-Tips-of-Searching-Github-Repositories-You-Should-Know/</id>
    <published>2019-01-25T01:03:04.000Z</published>
    <updated>2020-03-17T23:28:41.235Z</updated>
    
    <content type="html"><![CDATA[<p>You search on Google every day, and as a programmer, you would probably search on GitHub every day. Are you sure you know how to search GitHub repositories effectively? Let’s check out these 7 tips you probably didn’t know.</p><p><img src="https://www.dropbox.com/s/o6tae0ggy5hwqql/github-logo.png?dl=1" alt=""><a id="more"></a></p><h3 id="1-In-Name-In-Description-and-In-README"><a href="#1-In-Name-In-Description-and-In-README" class="headerlink" title="1. In Name, In Description, and In README"></a>1. In Name, In Description, and In README</h3><p>GitHub supports advance search in a certain field, like repository title, description, and README.</p><p>For example, you want to find some cool repository to learn Spring Cloud stuff, you can search like this:</p><p><code>in:name spring cloud</code></p><p><img src="../images/search-in-name.jpg" alt=""></p><p>In the same way, you can also search in description or README only:</p><p><code>in:description spring cloud</code><br><code>in:readme spring cloud</code></p><h3 id="2-More-Stars-More-Forks"><a href="#2-More-Stars-More-Forks" class="headerlink" title="2. More Stars, More Forks"></a>2. More Stars, More Forks</h3><p>Stars of a repository would provide information on how popular it is, which is an important metrics in consideration, as a result, you can search like this:</p><p><code>stars:&gt;=3000 spring cloud</code></p><p>You can also define a range like this:</p><p><code>forks:10..20 spring cloud</code></p><h3 id="3-Small-Repositories-Please"><a href="#3-Small-Repositories-Please" class="headerlink" title="3. Small Repositories Please"></a>3. Small Repositories Please</h3><p>Dinosaur repositories are not what you want, you love those simple, small and smart repositories only, you can add this search term:</p><p><code>size:&lt;=5000 spring cloud</code></p><p>Unit of size here is KB, so 5000 means 5MB.</p><h3 id="4-Actively-Maintained-Repositories-Please"><a href="#4-Actively-Maintained-Repositories-Please" class="headerlink" title="4. Actively Maintained Repositories Please"></a>4. Actively Maintained Repositories Please</h3><p>Most of the time you don’t want to rely on a project that didn’t update for 7 years, actively maintained projects would give you more confidence, thus you need to introduce last push time in your search term. For example, you want to search those projects have updates in the last two weeks:</p><p><code>pushed:&gt;2019-01-04 spring cloud</code></p><p>You may also search repositories created before or after a certain time using <code>created</code> rather than <code>push</code>.</p><h3 id="5-Apache-License-Please"><a href="#5-Apache-License-Please" class="headerlink" title="5. Apache License Please"></a>5. Apache License Please</h3><p>License of open source projects might bring you much trouble, you remember Facebook and React, right? If you want to search projects friendly licensed, for example, the well known Apache License 2, you would search like this:</p><p><code>license:apache-2.0 spring cloud</code></p><p>Of course, you can hunt other licenses also, just search in the <a href="https://help.github.com/articles/licensing-a-repository/" target="_blank" rel="noopener">complete list</a> provided by GitHub and choose the one you love.</p><h3 id="6-Java-Only"><a href="#6-Java-Only" class="headerlink" title="6. Java Only"></a>6. Java Only</h3><p><code>language:java</code> will filter repositories not written in Java, yeah! If you hate Java then replace it with the one you love, for example, the best programming language PHP.</p><h3 id="7-Rock-Star-Only"><a href="#7-Rock-Star-Only" class="headerlink" title="7. Rock Star Only"></a>7. Rock Star Only</h3><p>You may just want to search repositories by a Rock Star or a well-known organization because they are more likely awesome, just include <code>user</code> in your search term like this:</p><p><code>user:joshlong spring cloud</code><br><code>org:spring-cloud spring cloud</code></p><p>Obviously, you can combine the 7 tips together for more complex search, for example:</p><p><code>user:joshlong language:java pushed:&gt;2018-03-04 stars:&gt;200 in:description spring boot</code></p><p><img src="../images/combination-search.jpg" alt=""></p><h3 id="More-Options-to-Explore"><a href="#More-Options-to-Explore" class="headerlink" title="More Options to Explore"></a>More Options to Explore</h3><p>Want to explore all possible search terms? Just play around with <a href="https://github.com/search/advanced" target="_blank" rel="noopener">“Advanced Search”</a> or read the <a href="https://help.github.com/articles/about-searching-on-github/" target="_blank" rel="noopener">“search help”</a> by GitHub, the time you spent there will be definitely worthy.</p><p><img src="../images/advanced-search.jpg" alt=""></p><p><strong>Happy Hunting!</strong></p><p><em>PS:</em> If you are a Chinese reader you would like to read the original version by Shucheng Hou at <a href="https://mp.weixin.qq.com/s/__MXKPICzAL4mLetycfc9A" target="_blank" rel="noopener">here</a>. My post is a simplified and slightly modified English version actually.</p><script type="text/javascript">amzn_assoc_placement = "adunit0";amzn_assoc_search_bar = "true";amzn_assoc_tracking_id = "oldyoungboy-20";amzn_assoc_search_bar_position = "bottom";amzn_assoc_ad_mode = "search";amzn_assoc_ad_type = "smart";amzn_assoc_marketplace = "amazon";amzn_assoc_region = "US";amzn_assoc_title = "";amzn_assoc_default_search_phrase = "GitHub";amzn_assoc_default_category = "All";amzn_assoc_linkid = "3e67b5f3d8c58758abe55ca413b6ada4";</script><script src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US"></script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;You search on Google every day, and as a programmer, you would probably search on GitHub every day. Are you sure you know how to search GitHub repositories effectively? Let’s check out these 7 tips you probably didn’t know.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://www.dropbox.com/s/o6tae0ggy5hwqql/github-logo.png?dl=1&quot; alt=&quot;&quot;&gt;
    
    </summary>
    
      <category term="Tips" scheme="http://www.javaneversleep.com/categories/Tips/"/>
    
    
      <category term="GitHub" scheme="http://www.javaneversleep.com/tags/GitHub/"/>
    
  </entry>
  
  <entry>
    <title>7 Tips to Write Better Java Code You Should Know</title>
    <link href="http://www.javaneversleep.com/7-Tips-to-Write-Better-Java-Code-You-Should-Know/"/>
    <id>http://www.javaneversleep.com/7-Tips-to-Write-Better-Java-Code-You-Should-Know/</id>
    <published>2019-01-24T01:08:01.000Z</published>
    <updated>2020-03-18T05:46:29.561Z</updated>
    
    <content type="html"><![CDATA[<p>Yes, you can write short, clean Java code following 7 tips introduced in this article. Some of them might make you surprised, but trust me, they are proved practices - at least by me.</p><p><img src="https://www.dropbox.com/s/33nxcko1b69lcpp/java.jpg?dl=1" alt=""><a id="more"></a></p><h3 id="1-Use-IntelliJ-IDEA-as-your-IDE"><a href="#1-Use-IntelliJ-IDEA-as-your-IDE" class="headerlink" title="1. Use IntelliJ IDEA as your IDE"></a>1. Use <a href="https://www.jetbrains.com/idea/" target="_blank" rel="noopener">IntelliJ IDEA</a> as your IDE</h3><p>I’ve been using eclipse for 6 years and NetBeans for 3 years. I still use them sometimes, but most of the time I use IDEA only. I don’t want to start the holy war of IDEs here, but just want to tell you IDEA will remind you writing shorter, better, cleaner code based on its integrated best practices. You just press ALT+Enter and it will do the job for you, most of the time IDEA give smart and practical advice, you can also learn much new stuff from them.</p><p>To make good use of IDEA you’d better get an SSD, at least I did - my old laptop cannot run IDEA smoothly. Just a 256GB <a href="https://amzn.to/2RzwEbj" target="_blank" rel="noopener">Samsung SSD</a> will make your life much better. It’s a worthy investment if you are still using HDD.</p><div class="video-container"><iframe src="//www.youtube.com/embed/GSKERVTMWqs" frameborder="0" allowfullscreen></iframe></div><h3 id="2-Use-JDK8-or-higher-version"><a href="#2-Use-JDK8-or-higher-version" class="headerlink" title="2. Use JDK8 or higher version"></a>2. Use JDK8 or higher version</h3><p>From JDK8 on, many new features introduced will allow you to write shorter and more expressive code. Lambda Expressions, Functional Interfaces, Stream API and etc. You don’t need to remember them actually, as IDEA will assist you to use this features, that’s another reason why you should use IDEA. <a href="https://amzn.to/2rkOoM0" target="_blank" rel="noopener">“Java 8 in Action”</a> might be of some help to you.</p><h3 id="3-Use-Maven-Gradle"><a href="#3-Use-Maven-Gradle" class="headerlink" title="3. Use Maven / Gradle"></a>3. Use <a href="https://maven.apache.org/" target="_blank" rel="noopener">Maven</a> / <a href="https://gradle.org/" target="_blank" rel="noopener">Gradle</a></h3><p>Use Maven or Gradle to manage dependencies of your projects, to build and deploy them. If you have built many fundamental libraries to be reused among many projects, you’d better introduce Nexus if these libraries will be used internally only, otherwise, you can deploy to maven central repository.<br><img src="https://blog.philipphauer.de/blog/2018/0402-moving-back-from-gradle-to-maven/featured-image-large.png" alt=""></p><h3 id="4-Use-Lombok"><a href="#4-Use-Lombok" class="headerlink" title="4. Use Lombok"></a>4. Use <a href="https://projectlombok.org/" target="_blank" rel="noopener">Lombok</a></h3><p>Say goodbye to the boilerplate code of setter/getter, hashcode/equals, constructors/toString. Just one annotation @Data will work, it reduces the code you write, but take care of the generated bytecode.</p><h3 id="5-Write-Unit-Tests"><a href="#5-Write-Unit-Tests" class="headerlink" title="5. Write Unit Tests"></a>5. Write Unit Tests</h3><p>What? Are you serious?</p><p>Yes, I am. Testable code is usually organized better and cleaner, as it will drive you to manage the relationship of classes, the access level of methods and other stuff well beforehand. I’ve found that even minimum unit tests will make development much faster and easier, which always drive you to write shorter, cleaner and better code finally.</p><p>However, you will always hear honest opinions that “I don’t have time to write unit tests, it’s a waste of time as the deadline is approaching”. It sounds true and sometimes it’s true. But most of the time, from my experience I found it’s not true. If you don’t have time to write unit tests, you will “have” more time to fix bugs visible or invisible, without the quick feedback of unit test, the stability of code and new change usually decreases, and sometimes you may need to pray earnestly as you really don’t know what will happen or how many new bugs are introduced.</p><p>Maybe some genius programmers can write bug-free code without unit tests. But I am not and you probably are not, too. So just do it. Trust me, you will get the reward and love it soon. JUnit and TestNG would both work, though I prefer TestNG.</p><p><img src="https://384uqqh5pka2ma24ild282mv-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/junitvstestng.png" alt=""></p><h3 id="6-Refactoring-Frequently-but-Slowly"><a href="#6-Refactoring-Frequently-but-Slowly" class="headerlink" title="6. Refactoring: Frequently but Slowly"></a>6. Refactoring: Frequently but Slowly</h3><p>Shorter, cleaner code cannot be done at once, it needs iteratively improvements. Refactor little by little, and run test cases to make sure your change didn’t break the right behavior of the code, things will get better and better. IDEA provides great refactoring support, such as extract method, rename, inline and etc.</p><p>Martin Flower’s classic book <a href="https://amzn.to/2SuSm06" target="_blank" rel="noopener">“Refactoring: Improving the Design of Existing Code (2nd Edition)”</a> is a must-have if you have no idea what refactoring is.</p><h3 id="7-Visit-customer-regularly-and-get-feedback-from-them"><a href="#7-Visit-customer-regularly-and-get-feedback-from-them" class="headerlink" title="7. Visit customer regularly and get feedback from them"></a>7. Visit customer regularly and get feedback from them</h3><p>Honestly speaking this should be the first, but “the first will be last” here. You write code to resolve customer’s problems, to meet their requirements, to remove their pain points. Sometimes you just wasted too much time to implement features and functions that are unnecessary. But how to know that earlier? Keep in touch with customers regularly so that you can get their feedback as early as possible. However, this is not as easy as you think, even experienced product managers cannot get the point in a short time, less than programmers who mainly focus on implementing.</p><p>A practical suggestion is, if you cannot reach customer directly, you should connect to your product owner frequently and talk about your concern clearly but also politely, this will save all your time.</p><p>I’ve found these 7 tips useful to me in the past years and I hope it will also help you. Happy Coding!</p><p><strong>PS:</strong> This article was approved and published at <a href="https://dzone.com/" target="_blank" rel="noopener">DZone</a> on Dec 17, 2018 with slight changes from the Editor. <a href="https://dzone.com/articles/7-tips-to-write-better-java-code-you-should-know-1" target="_blank" rel="noopener">Click to Read</a></p><p>Zachary Goldberg, a former engineering lead at Google and Entrepreneur in Residence at Tencent, wrote a great article “<a href="https://www.toptal.com/software/six-commandments-of-good-code" target="_blank" rel="noopener"><strong>The Six Commandments of Good Code: Write Code That Stands the Test of Time</strong></a>“, which is really worthy to read.</p><script type="text/javascript">amzn_assoc_placement = "adunit0";amzn_assoc_search_bar = "false";amzn_assoc_tracking_id = "oldyoungboy-book-code-20";amzn_assoc_ad_mode = "manual";amzn_assoc_ad_type = "smart";amzn_assoc_marketplace = "amazon";amzn_assoc_region = "US";amzn_assoc_title = "";amzn_assoc_linkid = "a1b6fc683ac27c1f86192a68134e0647";amzn_assoc_asins = "B0781Z7Y3S,0201485672,1617291994,0132350882";</script><script src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US"></script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Yes, you can write short, clean Java code following 7 tips introduced in this article. Some of them might make you surprised, but trust me, they are proved practices - at least by me.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://www.dropbox.com/s/33nxcko1b69lcpp/java.jpg?dl=1&quot; alt=&quot;&quot;&gt;
    
    </summary>
    
      <category term="Tips" scheme="http://www.javaneversleep.com/categories/Tips/"/>
    
    
      <category term="Tips" scheme="http://www.javaneversleep.com/tags/Tips/"/>
    
  </entry>
  
  <entry>
    <title>Fibonacci and BigInteger: Secret Under the Hood</title>
    <link href="http://www.javaneversleep.com/Fibonacci-and-BigInteger/"/>
    <id>http://www.javaneversleep.com/Fibonacci-and-BigInteger/</id>
    <published>2019-01-21T06:53:17.000Z</published>
    <updated>2020-03-17T23:22:01.736Z</updated>
    
    <content type="html"><![CDATA[<p>No matter what programming language you are learning, Fibonacci numbers calculation is just too classic to skip. It seems very easy to implement, but also can be deep enough to catch up with, especially when the number is super big. Have you thought that ever before?</p><p><img src="https://www.dropbox.com/s/q88dhrsyh1q4q4i/rabbit.jpg?dl=1" alt=""><a id="more"></a></p><p>It can be super easy to implement using recursion in just one line of code, even using Java.😅</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fib</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> n &lt;= <span class="number">2</span> ? <span class="number">1</span> : (fib(n - <span class="number">1</span>) + fib(n - <span class="number">2</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>And to make you understand the basic optimization idea, monetization mechanism will be introduced via an integer array or a HashMap, but the idea is same: calculate once and only once, so that those poor rabbits would feel life much easier.</p><p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/7a/FibonacciRabbit.svg/640px-FibonacciRabbit.svg.png" alt=""></p><p>Add just one more line of code and thanks to the Lambdas feature provided since JDK8, life is much easier nowadays.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Integer, Integer&gt; CACHE = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fib</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> CACHE.computeIfAbsent(n, k -&gt; (k &lt;= <span class="number">2</span> ? <span class="number">1</span> : (fib(k - <span class="number">1</span>) + fib(k - <span class="number">2</span>))));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>There is always someone scared of the famous StackOverflowError, they would tell you not to use recursion but do an iterative way, like this:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fib</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (n &lt;= <span class="number">2</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>[] cache = <span class="keyword">new</span> <span class="keyword">int</span>[n];</span><br><span class="line">    cache[<span class="number">0</span>] = cache[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt; n; i++) &#123;</span><br><span class="line">        cache[i] = cache[i - <span class="number">1</span>] + cache[i - <span class="number">2</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cache[n - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Obviously, the integer array can be avoided, you can just keep three values and update them till the end, but that’s not the problem we want to discuss here. You would have probably found that it’s very easy for the result to be much bigger than the upper limit of int, long, double. For example, if we input n as 2048, what will be the exact result then?</p><p>454153044374378942504557144629068920270090826129364442895118239027897145250928343568434971 803477173043320774207501029966396250064078380187973638077418159157949680694899576625922604 895968605634843621876639428348247300097930657521757592440815188064651826480022197557589955 655164820646173515138267042115173436029259905997102292769397103720814141099147144935820441 85153918055170241694035610145547104337536614028338983073680262684101</p><p>It’s 4.54 * 10^427. As for Java, for this kind of problem, you have no other choice but <a href="https://docs.oracle.com/javase/8/docs/api/java/math/BigInteger.html" target="_blank" rel="noopener">BigInteger</a>, and it’s very easy to<br>use.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Integer, BigInteger&gt; CACHE = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function">BigInteger <span class="title">fib</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> CACHE.computeIfAbsent(n, k -&gt; (k &lt;= <span class="number">2</span> ? BigInteger.ONE : (fib(k - <span class="number">1</span>).add(fib(k - <span class="number">2</span>)))));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Congratulations! You will get a BOMB exploding like this:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread <span class="string">"main"</span> java.lang.StackOverflowError</span><br><span class="line">    at java.util.HashMap.hash(HashMap.java:<span class="number">339</span>)</span><br><span class="line">    at java.util.HashMap.computeIfAbsent(HashMap.java:<span class="number">1099</span>)</span><br></pre></td></tr></table></figure></p><p>You may use <code>-Xss4m</code> to shut it up, or resolve it in an iterative way a little bit optimized, wherein we won’t waste space to build an array. Yes, it’s right, recursion is easy to think of and implement, but it’s just too close to StackOverflowError.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BigInteger <span class="title">fib</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (n &lt;= <span class="number">2</span>) <span class="keyword">return</span> BigInteger.ONE;</span><br><span class="line"></span><br><span class="line">      BigInteger prev = BigInteger.ONE, prevOfPrev = BigInteger.ONE;</span><br><span class="line">      BigInteger curr = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt; n; i++) &#123;</span><br><span class="line">            curr = prev.add(prevOfPrev);</span><br><span class="line">            prevOfPrev = prev;</span><br><span class="line">            prev = curr;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> curr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>BigInteger, what’s the secret behind it that it can represent a number beyond the upper limit of all primitive data types of Java?</p><p>The idea is still simple, but the implementation can be complex, especially when highly optimized is a must. <a href="https://github.com/tbuktu/bigint" target="_blank" rel="noopener">bigint</a> in Github would give you more information on how Timothy Buktu approaches and optimizes it.</p><p>There is a famous quote in The Lord of The Rings by Sam, “I can’t carry it for you, but I can carry you”, as for BigInteger, it seems should be “I can’t carry it for you, and I can’t carry you, but I can carry a segment of you.”😅</p><p>Yes, the whole number is too big, but if we split it into many parts, then we will find each part might be within the upper limit, if we store each of them in an array, and perform the calculation in binary level, also handle the carrying part well, then a container to store a big number will be possible.</p><p>Pretty cool and smart, right? But what exactly is under the hood? Let’s check it out in the next post.</p><p><em><strong>TO BE CONTINUED</strong></em></p><script type="text/javascript">amzn_assoc_placement = "adunit0";amzn_assoc_search_bar = "false";amzn_assoc_tracking_id = "oldyoungboy-20";amzn_assoc_ad_mode = "manual";amzn_assoc_ad_type = "smart";amzn_assoc_marketplace = "amazon";amzn_assoc_region = "US";amzn_assoc_title = "";amzn_assoc_linkid = "21ce171baf5d871f0872d552bc2cbace";amzn_assoc_asins = "0805063056,B0015DWM2K,0767908163,1590787528";</script><script src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US"></script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;No matter what programming language you are learning, Fibonacci numbers calculation is just too classic to skip. It seems very easy to implement, but also can be deep enough to catch up with, especially when the number is super big. Have you thought that ever before?&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://www.dropbox.com/s/q88dhrsyh1q4q4i/rabbit.jpg?dl=1&quot; alt=&quot;&quot;&gt;
    
    </summary>
    
      <category term="Algorithm" scheme="http://www.javaneversleep.com/categories/Algorithm/"/>
    
    
      <category term="Fibonacci" scheme="http://www.javaneversleep.com/tags/Fibonacci/"/>
    
  </entry>
  
  <entry>
    <title>Refactoring 2nd Edition Available Now! A Masterpiece by Martin Fowler You Shall Never Miss!</title>
    <link href="http://www.javaneversleep.com/Refactoring-2nd-Available-A-Masterpiece-You-Shall-Never-Miss/"/>
    <id>http://www.javaneversleep.com/Refactoring-2nd-Available-A-Masterpiece-You-Shall-Never-Miss/</id>
    <published>2019-01-18T20:06:24.000Z</published>
    <updated>2020-03-17T23:22:01.739Z</updated>
    
    <content type="html"><![CDATA[<p>“Refactoring: Improving the Design of Existing Code”, the 2nd edition is available now! I read the first edition in 2009 for the first time. It significantly shaped my coding habit, which also made me promoted as the team leader in less than one year - I will tell you why later. After nearly 20 years this book was revised, enhanced, refactored and released. Trust me, you <strong>SHALL NEVER</strong> miss this masterpiece.</p><p><a href="https://amzn.to/2QviuLh" target="_blank" rel="noopener"><img src="https://www.dropbox.com/s/dbrkjhh7toukisc/refact2.jpg?dl=1"></a><a id="more"></a></p><p>Martin Fowler introduced a term called “Bad Smells” in this book and provides corresponding refactorings to resolve them. The methodology of unit test is a must for successful refactoring, as many programmers misunderstood at this part. They knew bad code smells and determined to remove them and they kept changing, but they didn’t perform unit test to make this process reliable and trustable. They usually gave up finally, and the complex, messy legacy code laughed at them in pride loudly.</p><p>In my first 3 years experience as a Java Software Engineer, I maintained a code base existing at least 3 years. It’s a mystery and a huge mess. You will never know how many new bugs will be introduced after you fix a bug. And it’s a nightmare to add some new features - I still remember one of the QA reported to his leader that he even cried when he found that the module is totally untestable - one bug fixed and another new pop up! Each step forward is more difficult than climbing the Himalayas. I don’t know whether he wants to kill me or not at that time. It’s lucky that I am still alive.</p><p>Fortunately, I found the 1st edition of Refactoring in bookshelf and started to read and practice. I applied several methods in the book, such as introduce parameter object, extract method, rename, remove middle class, extract super class and etc. However, I did this in spare time as other colleagues told me such change can be very dangerous, “at least the old code can run, things are not that bad”. But as the maintainer, I must say it’s too bad to bear any more. My manager is also suspicious and concern a lot about the time would be invested, “new features, rather than reorganization of existing code, are more valuable”. Totally agreed! Then I continued in spare time. Talk is cheap, I will show them the result.</p><p>I finished the first prototype after two weeks and presented to my manager. As expected, he was very happy to payback such technique debt and he even told me to share this among the team. With the protection of 60+ unit tests and necessary functional test, the finished refactoring made me, QA, project manager, and product manager all super happy. This is not the end. Adding new features or enhancing existing features became much easier than I expected, as after refactoring, the code was well organized and the re-usage rate was pretty good, you just need to change one place in a short time and all done. Previously, thanks to the Copy-Paste code style you never know how many other places were not touched and covered. QA also gave feedback that this module became much stabler than before, which means their test workload is reduced greatly. One of my colleagues was very surprised to see that this module reborn to be a clean, beautiful and easy to maintain code base, “how can this be, man?”, he asked.</p><p>After my team leader left for IBM, I was immediately promoted as the new team leader. Thanks to Refactoring! However, I would warn you, only those want to make a difference, write better code will be motivated to refactoring and perform unit tests, as this will never be easy. <em><strong>Patience, carefulness, boldness</strong></em> are all required to achieve the goal and reach the promise land.</p><p>Story time over, let’s go back to the topic. Martin Fowler introduced 15 completely new refactorings in 2nd edition, which I’d like to have a try immediately, who knows which role I will be promoted this time?</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Combine Functions into Class</span><br><span class="line">Combine Functions into Transform</span><br><span class="line">Move Statements into Function</span><br><span class="line">Move Statements to Callers</span><br><span class="line">Remove Dead Code</span><br><span class="line">Rename Field</span><br><span class="line">Rename Variable</span><br><span class="line">Replace Command with Function</span><br><span class="line">Replace Derived Variable with Query</span><br><span class="line">Replace Inline Code with Function Call</span><br><span class="line">Replace Loop with Pipeline</span><br><span class="line">Replace Query with Parameter</span><br><span class="line">Replace Subclass with Delegate</span><br><span class="line">Return Modified Value</span><br><span class="line">Split Phase</span><br></pre></td></tr></table></figure><p>There are also some other books I once read under this topic and maybe they will be helpful to you, too. I listed them here also. But if you can just pick up one, then it shall always be <em><strong>“Refactoring: Improving the Design of Existing Code”</strong></em>. Remember, the 2nd Edition this time.</p><script type="text/javascript">amzn_assoc_placement = "adunit0";amzn_assoc_search_bar = "false";amzn_assoc_tracking_id = "oldyoungboy-20";amzn_assoc_ad_mode = "manual";amzn_assoc_ad_type = "smart";amzn_assoc_marketplace = "amazon";amzn_assoc_region = "US";amzn_assoc_title = "";amzn_assoc_linkid = "67450530ae19c250a2e7773d9911f72b";amzn_assoc_asins = "0134757599,0131177052,0132350882,020161622X";</script><script src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US"></script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;“Refactoring: Improving the Design of Existing Code”, the 2nd edition is available now! I read the first edition in 2009 for the first time. It significantly shaped my coding habit, which also made me promoted as the team leader in less than one year - I will tell you why later. After nearly 20 years this book was revised, enhanced, refactored and released. Trust me, you &lt;strong&gt;SHALL NEVER&lt;/strong&gt; miss this masterpiece.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://amzn.to/2QviuLh&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;img src=&quot;https://www.dropbox.com/s/dbrkjhh7toukisc/refact2.jpg?dl=1&quot;&gt;&lt;/a&gt;
    
    </summary>
    
      <category term="Great Books" scheme="http://www.javaneversleep.com/categories/Great-Books/"/>
    
    
      <category term="Refactoring" scheme="http://www.javaneversleep.com/tags/Refactoring/"/>
    
  </entry>
  
  <entry>
    <title>Behind-the-Scenes Secrets of Jsoup V: Tips &amp; Tricks of Optimization</title>
    <link href="http://www.javaneversleep.com/Behind-the-Scenes-Secrets-of-Jsoup-05-Tips-And-Tricks/"/>
    <id>http://www.javaneversleep.com/Behind-the-Scenes-Secrets-of-Jsoup-05-Tips-And-Tricks/</id>
    <published>2019-01-16T17:02:51.000Z</published>
    <updated>2020-03-17T23:22:01.734Z</updated>
    
    <content type="html"><![CDATA[<p>We have done things right, now it’s time to do things faster. We would keep <a href="https://en.wikipedia.org/wiki/Donald_Knuth" target="_blank" rel="noopener">Donald Knuth</a>‘s warning in mind, “We should forget about small efficiencies, say about 97% of the time: premature optimization is the root of all evil”.</p><p><img src="https://www.dropbox.com/s/0773b7bsya9ph9i/racing-horse.jpg?dl=1" alt=""><a id="more"></a></p><p>According to Jonathan Hedley, he uses <a href="https://www.yourkit.com/java/profiler/" target="_blank" rel="noopener">YourKit Java Profiler</a> to measure memory usage and find the performance hot point. Using statistic result of such kind of tools is crucial for the success of optimizations, it will prevent you spend time just wondering and making useless tunings, which doesn’t improve performance but also make your code unnecessarily complex and hard to maintain. Jonathan also talked about this in the <a href="https://jsoup.org/colophon" target="_blank" rel="noopener">“Colophon”</a>.</p><p>We will list some tips and tricks used in Jsoup, they are randomly ordered currently, would be re-organized in the future.</p><h3 id="1-Padding-for-Indent"><a href="#1-Padding-for-Indent" class="headerlink" title="1. Padding for Indent"></a>1. Padding for Indent</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// memoised padding up to 21, from "", " ", "  " to "                   "</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> String[] padding = &#123;......&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">padding</span><span class="params">(<span class="keyword">int</span> width)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (width &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"width must be &gt; 0"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (width &lt; padding.length)</span><br><span class="line">        <span class="keyword">return</span> padding[width];</span><br><span class="line">    <span class="keyword">char</span>[] out = <span class="keyword">new</span> <span class="keyword">char</span>[width];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; width; i++)</span><br><span class="line">        out[i] = <span class="string">' '</span>;</span><br><span class="line">    <span class="keyword">return</span> String.valueOf(out);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">indent</span><span class="params">(Appendable accum, <span class="keyword">int</span> depth, Document.OutputSettings out)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    accum.append(<span class="string">'\n'</span>).append(StringUtil.padding(depth * out.indentAmount()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Pretty smart, right? It maintains a cache of different lengths of paddings which would cover 80% of the cases - which I assume would be based on the author’s experience and statistic.</p><h3 id="2-Has-Class-Or-Not"><a href="#2-Has-Class-Or-Not" class="headerlink" title="2. Has Class Or Not?"></a>2. Has Class Or Not?</h3><p><a href="https://github.com/jhy/jsoup/blob/master/src/main/java/org/jsoup/nodes/Element.java#L1270" target="_blank" rel="noopener"><code>Element#hasClass</code></a> was marked as <strong>performance sensitive</strong>, for example, we want to check whether <code>&lt;div class=&quot;logged-in env-production intent-mouse&quot;&gt;</code> has class <code>production</code>, split class by whitespace to an array then loop and search would work, but in a deep traverse this would be in-efficiency. Jsoup introduces <strong>Early Exit</strong> here first, by compare length with target class name to avoid unnecessary scan and search, which will also be beneficial. Then it uses a pointer detecting whitespace and performs regionMatches - honestly speaking this is the first time I got to know method <code>String#regionMatches</code>🙈😅</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasClass</span><span class="params">(String className)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String classAttr = attributes().getIgnoreCase(<span class="string">"class"</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> len = classAttr.length();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> wantLen = className.length();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (len == <span class="number">0</span> || len &lt; wantLen) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if both lengths are equal, only need compare the className with the attribute</span></span><br><span class="line">    <span class="keyword">if</span> (len == wantLen) &#123;</span><br><span class="line">        <span class="keyword">return</span> className.equalsIgnoreCase(classAttr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// otherwise, scan for whitespace and compare regions (with no string or arraylist allocations)</span></span><br><span class="line">    <span class="keyword">boolean</span> inClass = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">int</span> start = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Character.isWhitespace(classAttr.charAt(i))) &#123;</span><br><span class="line">            <span class="keyword">if</span> (inClass) &#123;</span><br><span class="line">                <span class="comment">// white space ends a class name, compare it with the requested one, ignore case</span></span><br><span class="line">                <span class="keyword">if</span> (i - start == wantLen &amp;&amp; classAttr.regionMatches(<span class="keyword">true</span>, start, className, <span class="number">0</span>, wantLen)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                inClass = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!inClass) &#123;</span><br><span class="line">                <span class="comment">// we're in a class name : keep the start of the substring</span></span><br><span class="line">                inClass = <span class="keyword">true</span>;</span><br><span class="line">                start = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check the last entry</span></span><br><span class="line">    <span class="keyword">if</span> (inClass &amp;&amp; len - start == wantLen) &#123;</span><br><span class="line">        <span class="keyword">return</span> classAttr.regionMatches(<span class="keyword">true</span>, start, className, <span class="number">0</span>, wantLen);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-Tag-Name-In-or-Not"><a href="#3-Tag-Name-In-or-Not" class="headerlink" title="3. Tag Name In or Not?"></a>3. Tag Name In or Not?</h3><p>As we analyzed in previous articles, <code>HtmlTreeBuilderState</code> will validate nest correctness by checking whether tag name in a certain collection or not. We can compare the implementation before and after <em>1.7.3</em> to have a check.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.7.2</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (StringUtil.in(name, <span class="string">"base"</span>, <span class="string">"basefont"</span>, <span class="string">"bgsound"</span>, <span class="string">"command"</span>, <span class="string">"link"</span>, <span class="string">"meta"</span>, <span class="string">"noframes"</span>, <span class="string">"script"</span>, <span class="string">"style"</span>, <span class="string">"title"</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> tb.process(t, InHead);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.7.3</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> String[] InBodyStartToHead = <span class="keyword">new</span> String[]&#123;<span class="string">"base"</span>, <span class="string">"basefont"</span>, <span class="string">"bgsound"</span>, <span class="string">"command"</span>, <span class="string">"link"</span>, <span class="string">"meta"</span>, <span class="string">"noframes"</span>, <span class="string">"script"</span>, <span class="string">"style"</span>, <span class="string">"title"</span>&#125;;</span><br><span class="line">...</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (StringUtil.inSorted(name, Constants.InBodyStartToHead)) &#123;</span><br><span class="line">    <span class="keyword">return</span> tb.process(t, InHead);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>According to the comment written by the author, “A little harder to read here, but causes less GC than dynamic varargs. Was contributing around 10% of parse GC load. Must make sure these are sorted, as used in findSorted”. Simply using <code>static final</code> constant array, also make them sorted so that binary search will also improve from O(n) to O(log(n)), the cost–performance ratio is pretty good here.</p><p>However, “MUST update HtmlTreebuilderStateTest if more arrays added” is not a good way to synchronize IMHO, rather than Copy &amp; Paste I would use reflection to retrieve those constants. You may find my proposal in Pull Request <a href="https://github.com/jhy/jsoup/pull/1157" target="_blank" rel="noopener">#1157: “Simplify state sorting status unit test - avoid duplicated code in HtmlTreeBuilderStateTest.java”</a>.</p><h3 id="4-Flyweight-Pattern"><a href="#4-Flyweight-Pattern" class="headerlink" title="4. Flyweight Pattern"></a>4. Flyweight Pattern</h3><p>Do you know the trick of <code>Integer.valueOf(i)</code>? It maintains a <code>IntegerCache</code> cache from -128 to 127 or higher if configured(<code>java.lang.Integer.IntegerCache.high</code>), as a result, <code>==</code> and <code>equals</code> result will be different when the value is located in a different range(a classic Java interview question?). This is an example of <a href="https://en.wikipedia.org/wiki/Flyweight_pattern" target="_blank" rel="noopener">Flyweight Pattern</a> actually. As for Jsoup, applying this pattern will also reduce object created times and gain benefit to performance.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Caches short strings, as a flywheel pattern, to reduce GC load. Just for this doc, to prevent leaks.</span></span><br><span class="line"><span class="comment"> * &lt;p /&gt;</span></span><br><span class="line"><span class="comment"> * Simplistic, and on hash collisions just falls back to creating a new string, vs a full HashMap with Entry list.</span></span><br><span class="line"><span class="comment"> * That saves both having to create objects as hash keys, and running through the entry list, at the expense of</span></span><br><span class="line"><span class="comment"> * some more duplicates.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">cacheString</span><span class="params">(<span class="keyword">final</span> <span class="keyword">char</span>[] charBuf, <span class="keyword">final</span> String[] stringCache, <span class="keyword">final</span> <span class="keyword">int</span> start, <span class="keyword">final</span> <span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// limit (no cache):</span></span><br><span class="line">    <span class="keyword">if</span> (count &gt; maxStringCacheLen)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String(charBuf, start, count);</span><br><span class="line">    <span class="keyword">if</span> (count &lt; <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// calculate hash:</span></span><br><span class="line">    <span class="keyword">int</span> hash = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> offset = start;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        hash = <span class="number">31</span> * hash + charBuf[offset++];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get from cache</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> index = hash &amp; stringCache.length - <span class="number">1</span>;</span><br><span class="line">    String cached = stringCache[index];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cached == <span class="keyword">null</span>) &#123; <span class="comment">// miss, add</span></span><br><span class="line">        cached = <span class="keyword">new</span> String(charBuf, start, count);</span><br><span class="line">        stringCache[index] = cached;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// hashcode hit, check equality</span></span><br><span class="line">        <span class="keyword">if</span> (rangeEquals(charBuf, start, count, cached)) &#123; <span class="comment">// hit</span></span><br><span class="line">            <span class="keyword">return</span> cached;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// hashcode conflict</span></span><br><span class="line">            cached = <span class="keyword">new</span> String(charBuf, start, count);</span><br><span class="line">            stringCache[index] = cached; <span class="comment">// update the cache, as recently used strings are more likely to show up again</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cached;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>There is also another scenario to minimize new StringBuilder GCs using the same idea.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Stack&lt;StringBuilder&gt; builders = <span class="keyword">new</span> Stack&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Maintains cached StringBuilders in a flyweight pattern, to minimize new StringBuilder GCs. The StringBuilder is</span></span><br><span class="line"><span class="comment"> * prevented from growing too large.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Care must be taken to release the builder once its work has been completed, with &#123;<span class="doctag">@see</span> #releaseBuilder&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> StringBuilder <span class="title">borrowBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (builders) &#123;</span><br><span class="line">        <span class="keyword">return</span> builders.empty() ?</span><br><span class="line">            <span class="keyword">new</span> StringBuilder(MaxCachedBuilderSize) :</span><br><span class="line">            builders.pop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Actually, <a href="https://github.com/jhy/jsoup/blob/master/src/main/java/org/jsoup/parser/CharacterReader.java" target="_blank" rel="noopener"><code>CharacterReader</code></a> and <a href="https://github.com/jhy/jsoup/blob/master/src/main/java/org/jsoup/internal/StringUtil.java" target="_blank" rel="noopener"><code>StringUtil</code></a> are worthy to digest more and more as there are many useful tips and tricks that will inspire you.</p><h3 id="5-Other-Improvement-Methods"><a href="#5-Other-Improvement-Methods" class="headerlink" title="5. Other Improvement Methods"></a>5. Other Improvement Methods</h3><ul><li>Use RandomAccessFile to read files that improved file read time by 2x. Check <a href="https://github.com/jhy/jsoup/issues/248" target="_blank" rel="noopener">#248</a> for more details</li><li>Node hierarchy refactoring. Check <a href="https://github.com/jhy/jsoup/issues/911" target="_blank" rel="noopener">#911</a> for more details</li><li>“Improvements largely from re-ordering the HtmlTreeBuilder methods based on analysis of various websites” - I list this one here because it’s very practical. Deeper understanding and observation of how the code will run will also give you some insights</li><li>Call <code>list.toArray(0)</code> rather than <code>list.toArray(list.size())</code> - this has been used in certain open source projects such as <a href="https://github.com/h2database/h2database/issues/311" target="_blank" rel="noopener">h2database</a>, so I also proposed this in another Pull Request <a href="https://github.com/jhy/jsoup/pull/1158" target="_blank" rel="noopener">#1158</a></li></ul><h3 id="6-The-Unknowns"><a href="#6-The-Unknowns" class="headerlink" title="6. The Unknowns"></a>6. The Unknowns</h3><p>Optimization never ends. There are still many tips and tricks I didn’t discover at this time. I would appreciate if you can share them to me if you find more inspiring ideas in Jsoup. You may find my contact information in the left sidebar of this website or simply email to <code>ny83427 at gmail.com</code>.</p><p><strong>-To Be Continued-</strong></p><iframe src="//rcm-na.amazon-adsystem.com/e/cm?o=1&p=48&l=ur1&category=books&banner=0HX1M2P8DDZ20D689R82&f=ifr&linkID=61f529dfb8b35107c92efc29a2c3c8dc&t=javaneversleep-20&tracking_id=javaneversleep-20" width="728" height="90" scrolling="no" border="0" marginwidth="0" style="border:none;" frameborder="0"></iframe>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;We have done things right, now it’s time to do things faster. We would keep &lt;a href=&quot;https://en.wikipedia.org/wiki/Donald_Knuth&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Donald Knuth&lt;/a&gt;‘s warning in mind, “We should forget about small efficiencies, say about 97% of the time: premature optimization is the root of all evil”.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://www.dropbox.com/s/0773b7bsya9ph9i/racing-horse.jpg?dl=1&quot; alt=&quot;&quot;&gt;
    
    </summary>
    
      <category term="Code Review" scheme="http://www.javaneversleep.com/categories/Code-Review/"/>
    
    
      <category term="Jsoup" scheme="http://www.javaneversleep.com/tags/Jsoup/"/>
    
  </entry>
  
  <entry>
    <title>Behind-the-Scenes Secrets of Jsoup IV: CSS Selector</title>
    <link href="http://www.javaneversleep.com/Behind-the-Scenes-Secrets-of-Jsoup-04-CSS-Selector/"/>
    <id>http://www.javaneversleep.com/Behind-the-Scenes-Secrets-of-Jsoup-04-CSS-Selector/</id>
    <published>2019-01-15T04:40:04.000Z</published>
    <updated>2020-03-17T23:22:01.733Z</updated>
    
    <content type="html"><![CDATA[<p>Most of the time, you are just consuming the <code>Document</code> Jsoup built for you, like <code>document.select(${selector})</code>. It would be helpful to go through <a href="https://www.w3.org/TR/CSS2/selector.html" target="_blank" rel="noopener">W3C CSS Selector Specification</a> to understand Jsoup’s roadmap. We have talked about Node Traverse before, what <code>Selector</code> will actually do is just filtering and collecting while traversing, and the key point here will be parsing and evaluating given queries.</p><p><img src="https://www.dropbox.com/s/819qqsi6sr9kjhc/make-coffee.jpg?dl=1" alt=""><a id="more"></a></p><h3 id="Overview-of-Package"><a href="#Overview-of-Package" class="headerlink" title="Overview of Package"></a>Overview of Package</h3><p>Package <code>org.jsoup.select</code> didn’t change much in latest version <em>1.12.1-SNAPSHOT</em>, I would reference UML diagram made by <a href="https://github.com/code4craft/" target="_blank" rel="noopener">Yihua Huang</a> directly here:</p><p><img src="../images/select-uml-Yihua-Huang.jpeg" alt=""></p><p>Besides <code>NodeVistor</code> the interface, there is another similar interface <code>NodeFilter</code>, their methods are nearly the same:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">NodeFilter</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Filter decision.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">enum</span> FilterResult &#123;</span><br><span class="line">        <span class="comment">/** Continue processing the tree */</span></span><br><span class="line">        CONTINUE,</span><br><span class="line">        <span class="comment">/** Skip the child nodes, but do call &#123;<span class="doctag">@link</span> NodeFilter#tail(Node, int)&#125; next. */</span></span><br><span class="line">        SKIP_CHILDREN,</span><br><span class="line">        <span class="comment">/** Skip the subtree, and do not call &#123;<span class="doctag">@link</span> NodeFilter#tail(Node, int)&#125;. */</span></span><br><span class="line">        SKIP_ENTIRELY,</span><br><span class="line">        <span class="comment">/** Remove the node and its children */</span></span><br><span class="line">        REMOVE,</span><br><span class="line">        <span class="comment">/** Stop processing */</span></span><br><span class="line">        STOP</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Callback for when a node is first visited.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">FilterResult <span class="title">head</span><span class="params">(Node node, <span class="keyword">int</span> depth)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Callback for when a node is last visited, after all of its descendants have been visited.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">FilterResult <span class="title">tail</span><span class="params">(Node node, <span class="keyword">int</span> depth)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>There is only one implementation in production code, which is <code>FirstFinder</code>, 5 other implementations are all located in test and probably reserved for the future. As for <code>FirstFinder</code>, it’s easy to guess that it’s created in the purpose of optimization. You don’t need to collect all the matching elements and return the first one, instead of invoking <code>select(${selector}).get(0)</code>, Jsoup introduces another method <code>selectFirst(${selector})</code> which will be useful when you just care about the first one - a frequent scenario actually.</p><h3 id="NodeFilter-Another-Traverse"><a href="#NodeFilter-Another-Traverse" class="headerlink" title="NodeFilter: Another Traverse"></a>NodeFilter: Another Traverse</h3><p>I don’t want to repeat Node Traverse here again, but it will be helpful to review it in another way - the implementation of filtering. The idea and workflow are totally the same, but a little bit longer. You may compare to <a href="https://github.com/jhy/jsoup/blob/master/src/main/java/org/jsoup/select/NodeTraversor.java#L40" target="_blank" rel="noopener"><code>NodeTraversor#traverse</code></a> for better understanding.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> FilterResult <span class="title">filter</span><span class="params">(NodeFilter filter, Node root)</span> </span>&#123;</span><br><span class="line">    Node node = root;</span><br><span class="line">    <span class="keyword">int</span> depth = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (node != <span class="keyword">null</span>) &#123;</span><br><span class="line">        FilterResult result = filter.head(node, depth);</span><br><span class="line">        <span class="keyword">if</span> (result == FilterResult.STOP)</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        <span class="comment">// Descend into child nodes:</span></span><br><span class="line">        <span class="keyword">if</span> (result == FilterResult.CONTINUE &amp;&amp; node.childNodeSize() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            node = node.childNode(<span class="number">0</span>);</span><br><span class="line">            ++depth;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// No siblings, move upwards:</span></span><br><span class="line">        <span class="keyword">while</span> (node.nextSibling() == <span class="keyword">null</span> &amp;&amp; depth &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 'tail' current node:</span></span><br><span class="line">            <span class="keyword">if</span> (result == FilterResult.CONTINUE || result == FilterResult.SKIP_CHILDREN) &#123;</span><br><span class="line">                result = filter.tail(node, depth);</span><br><span class="line">                <span class="keyword">if</span> (result == FilterResult.STOP)</span><br><span class="line">                    <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">            Node prev = node; <span class="comment">// In case we need to remove it below.</span></span><br><span class="line">            node = node.parentNode();</span><br><span class="line">            depth--;</span><br><span class="line">            <span class="keyword">if</span> (result == FilterResult.REMOVE)</span><br><span class="line">                prev.remove(); <span class="comment">// Remove AFTER finding parent.</span></span><br><span class="line">            result = FilterResult.CONTINUE; <span class="comment">// Parent was not pruned.</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 'tail' current node, then proceed with siblings:</span></span><br><span class="line">        <span class="keyword">if</span> (result == FilterResult.CONTINUE || result == FilterResult.SKIP_CHILDREN) &#123;</span><br><span class="line">            result = filter.tail(node, depth);</span><br><span class="line">            <span class="keyword">if</span> (result == FilterResult.STOP)</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (node == root)</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        Node prev = node; <span class="comment">// In case we need to remove it below.</span></span><br><span class="line">        node = node.nextSibling();</span><br><span class="line">        <span class="keyword">if</span> (result == FilterResult.REMOVE)</span><br><span class="line">            prev.remove(); <span class="comment">// Remove AFTER finding sibling.</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// root == null?</span></span><br><span class="line">    <span class="keyword">return</span> FilterResult.CONTINUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Using <code>FirstFinder</code> as an example, the idea is straightforward. It keeps the evaluator and the matching result, and return a <code>FilterResult</code> of STOP when the first matching element was found.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FirstFinder</span> <span class="keyword">implements</span> <span class="title">NodeFilter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Element root;</span><br><span class="line">    <span class="keyword">private</span> Element match = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Evaluator eval;</span><br><span class="line"></span><br><span class="line">    FirstFinder(Element root, Evaluator eval) &#123;</span><br><span class="line">        <span class="keyword">this</span>.root = root;</span><br><span class="line">        <span class="keyword">this</span>.eval = eval;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterResult <span class="title">head</span><span class="params">(Node node, <span class="keyword">int</span> depth)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (node <span class="keyword">instanceof</span> Element) &#123;</span><br><span class="line">            Element el = (Element) node;</span><br><span class="line">            <span class="keyword">if</span> (eval.matches(root, el)) &#123;</span><br><span class="line">                match = el;</span><br><span class="line">                <span class="keyword">return</span> STOP;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> CONTINUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterResult <span class="title">tail</span><span class="params">(Node node, <span class="keyword">int</span> depth)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> CONTINUE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="The-Evaluators"><a href="#The-Evaluators" class="headerlink" title="The Evaluators"></a>The Evaluators</h3><p>OK. We have gone through the traverse again via review the filtering function. Now it’s time to understand how Jsoup parse a given query. We will look at <code>Evaluator</code>, <code>CombiningEvaluator</code>, and <code>StructuralEvaluator</code> first.</p><ul><li><p><code>Evaluator</code> is a abstract class with 39 inherited subclasses which cover querying by id, name, tagName(equals or endsWith), class, attribute name, attribute value, sibling index, texts, regex match and etc. Since we have set these properties well while parsing the DOM tree, it will be very easy to implement the abstract method:</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Test if the element meets the evaluator's requirements.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(Element root, Element element)</span></span>;</span><br></pre></td></tr></table></figure></li><li><p><code>CombiningEvaluator</code> combines multiple evaluators with logic expression <code>And</code> or <code>Or</code>, which can process combinators like <code>&quot;,&quot;, &quot;&gt;&quot;, &quot;+&quot;, &quot;~&quot;, &quot; &quot;</code></p></li><li><p><code>StructuralEvaluator</code> is used to simulate query like <code>div &gt; p &gt; span</code> or <code>div p span</code>. <code>ImmediateParent</code> will handle <code>div &gt; p &gt; span</code> while <code>Parent</code> will handle <code>div p span</code>. We will take a look at <code>Parent</code> implementation:</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Parent</span> <span class="keyword">extends</span> <span class="title">StructuralEvaluator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Parent</span><span class="params">(Evaluator evaluator)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.evaluator = evaluator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(Element root, Element element)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (root == element)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        Element parent = element.parent();</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (evaluator.matches(root, parent))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (parent == root)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            parent = parent.parent();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">":parent%s"</span>, evaluator);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  And <a href="https://github.com/jhy/jsoup/blob/master/src/main/java/org/jsoup/select/QueryParser.java" target="_blank" rel="noopener"><code>QueryParser</code></a> that will parse a CSS selector into an Evaluator tree, handle above cases like this:</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// for most combinators: change the current eval into an AND of the current eval and the new eval</span></span><br><span class="line"><span class="keyword">if</span> (combinator == <span class="string">'&gt;'</span>)</span><br><span class="line">    currentEval = <span class="keyword">new</span> CombiningEvaluator.And(newEval, <span class="keyword">new</span> StructuralEvaluator.ImmediateParent(currentEval));</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (combinator == <span class="string">' '</span>)</span><br><span class="line">    currentEval = <span class="keyword">new</span> CombiningEvaluator.And(newEval, <span class="keyword">new</span> StructuralEvaluator.Parent(currentEval));</span><br><span class="line">...</span><br></pre></td></tr></table></figure></li></ul><h3 id="QueryParser-Finally"><a href="#QueryParser-Finally" class="headerlink" title="QueryParser Finally"></a>QueryParser Finally</h3><p>After we explored different kinds of <code>Evaluator</code>, it will be easy to understand the parsing process in the below:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">QueryParser</span><span class="params">(String query)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.query = query;</span><br><span class="line">    <span class="keyword">this</span>.tq = <span class="keyword">new</span> TokenQueue(query);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Evaluator <span class="title">parse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    tq.consumeWhitespace();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tq.matchesAny(combinators)) &#123; <span class="comment">// if starts with a combinator, use root as elements</span></span><br><span class="line">        evals.add(<span class="keyword">new</span> StructuralEvaluator.Root());</span><br><span class="line">        combinator(tq.consume());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        findElements();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!tq.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// hierarchy and extras</span></span><br><span class="line">        <span class="keyword">boolean</span> seenWhite = tq.consumeWhitespace();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (tq.matchesAny(combinators)) &#123;</span><br><span class="line">            combinator(tq.consume());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (seenWhite) &#123;</span><br><span class="line">            combinator(<span class="string">' '</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// E.class, E#id, E[attr] etc. AND</span></span><br><span class="line">            findElements(); <span class="comment">// take next el, #. etc off queue</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (evals.size() == <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> evals.get(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CombiningEvaluator.And(evals);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Easier than expected, right? The implementation here is clean, elegant and easy to understand. Besides that, java doc of <code>Selector</code> is also impressive, you can play around with <a href="https://try.jsoup.org/" target="_blank" rel="noopener">Try Jsoup</a> with <a href="https://jsoup.org/apidocs/org/jsoup/select/Selector.html" target="_blank" rel="noopener">Selector syntax</a>.</p><p><strong>-To Be Continued-</strong></p><iframe src="//rcm-na.amazon-adsystem.com/e/cm?o=1&p=48&l=ur1&category=books&banner=0HX1M2P8DDZ20D689R82&f=ifr&linkID=61f529dfb8b35107c92efc29a2c3c8dc&t=javaneversleep-20&tracking_id=javaneversleep-20" width="728" height="90" scrolling="no" border="0" marginwidth="0" style="border:none;" frameborder="0"></iframe>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Most of the time, you are just consuming the &lt;code&gt;Document&lt;/code&gt; Jsoup built for you, like &lt;code&gt;document.select(${selector})&lt;/code&gt;. It would be helpful to go through &lt;a href=&quot;https://www.w3.org/TR/CSS2/selector.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;W3C CSS Selector Specification&lt;/a&gt; to understand Jsoup’s roadmap. We have talked about Node Traverse before, what &lt;code&gt;Selector&lt;/code&gt; will actually do is just filtering and collecting while traversing, and the key point here will be parsing and evaluating given queries.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://www.dropbox.com/s/819qqsi6sr9kjhc/make-coffee.jpg?dl=1&quot; alt=&quot;&quot;&gt;
    
    </summary>
    
      <category term="Code Review" scheme="http://www.javaneversleep.com/categories/Code-Review/"/>
    
    
      <category term="Jsoup" scheme="http://www.javaneversleep.com/tags/Jsoup/"/>
    
  </entry>
  
  <entry>
    <title>Behind-the-Scenes Secrets of Jsoup III: The Tree and The State Machine</title>
    <link href="http://www.javaneversleep.com/Behind-the-Scenes-Secrets-of-Jsoup-03-Build-The-Tree/"/>
    <id>http://www.javaneversleep.com/Behind-the-Scenes-Secrets-of-Jsoup-03-Build-The-Tree/</id>
    <published>2019-01-13T20:08:14.000Z</published>
    <updated>2020-03-17T23:22:01.732Z</updated>
    
    <content type="html"><![CDATA[<p>Ready? The challenging task finally came. We will build a tree this time so that you don’t have to traverse before it was built.😅<code>TreeBuilder</code> has two implementations, <code>XmlTreeBuilder</code> is relatively easy while <code>HtmlTreeBuilder</code> is much more complex. And we will go through them today.</p><p><img src="https://www.dropbox.com/s/lomj0ikzg2es1j4/build-tree.jpg?dl=1" alt=""><a id="more"></a></p><h3 id="Overview-of-Package"><a href="#Overview-of-Package" class="headerlink" title="Overview of Package"></a>Overview of Package</h3><p>I will skip general introduction about Compiler, Lex, Parser as there are too many articles talking about them. We will go to Jsoup source code directly. Let’s have a quick look at several classes under package <code>org.jsoup.parser</code>.</p><ul><li><p><code>Parser</code>: Facade of Jsoup parsing.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> TreeBuilder treeBuilder;  <span class="comment">// this is the man who actually do the job</span></span><br><span class="line"><span class="keyword">private</span> ParseErrorList errors;    <span class="comment">// by default Jsoup didn't collect errors of html but you can enable this</span></span><br><span class="line"><span class="keyword">private</span> ParseSettings settings;   <span class="comment">// switches of preserveTagCase and preserveAttributeCase</span></span><br></pre></td></tr></table></figure></li><li><p><code>Token</code>: Parse tokens for the Tokeniser. It’s a abstract class with 6 subclasses: <code>Doctype</code>, <code>StartTag</code>, <code>EndTag</code>, <code>Comment</code>, <code>Character</code>, <code>EOF</code></p></li><li><p><code>Tokeniser</code>: Read input stream into tokens. It keeps current <code>state</code> and <code>emitPending</code> as the token we are about to emit on next read, it also keeps <code>tagPending</code>, <code>startPending</code>, <code>endPending</code>, <code>charPending</code>, <code>doctypePending</code>, and <code>commentPending</code> before tokens were filled up completely</p></li><li><p><code>CharacterReader</code>: consumes tokens off a string, it might be inspired from <code>ByteBuffer</code> of NIO as there are similar methods like <code>consume()</code>、<code>unconsume()</code>、<code>mark()</code>、<code>rewindToMark()</code> and <code>consumeTo()</code></p></li><li><p><code>TokeniserState</code> and <code>HtmlTreeBuilderState</code>: Lexing/Parsing State Machine. Jsoup applied State Pattern to implement it using enumerations, which is a classic example of design pattern usage also. Using a transition table is easy for the transition between different states but would be difficult to perform extra work during the transition</p></li><li><p><code>HtmlTreeBuilder</code> and <code>XmlTreeBuilder</code>: I list them in the end as they basically play a role like a manager, collaborating <code>Tokeniser</code> and Lexing, Parsing State Machine to finish the work</p></li></ul><p>Lexing and Parsing State Pattern implementation would the most complex part of Jsoup. You can get to know this even just from lines of code statistics. Top 7 source files here!</p><table><thead><tr><th>File</th><th>blank</th><th>comment</th><th>code</th></tr></thead><tbody><tr><td><strong>org.jsoup.parser.TokeniserState.java</strong></td><td>27</td><td>46</td><td>1671</td></tr><tr><td><strong>org.jsoup.parser.HtmlTreeBuilderState.java</strong></td><td>43</td><td>56</td><td>1429</td></tr><tr><td>org.jsoup.helper.HttpConnection.java</td><td>162</td><td>51</td><td>979</td></tr><tr><td>org.jsoup.nodes.Element.java</td><td>156</td><td>604</td><td>727</td></tr><tr><td>org.jsoup.parser.HtmlTreeBuilder.java</td><td>104</td><td>38</td><td>591</td></tr><tr><td>org.jsoup.select.Evaluator.java</td><td>139</td><td>107</td><td>532</td></tr><tr><td>org.jsoup.parser.CharacterReader.java</td><td>60</td><td>61</td><td>385</td></tr></tbody></table><h3 id="State-Machine-and-State-Pattern"><a href="#State-Machine-and-State-Pattern" class="headerlink" title="State Machine and State Pattern"></a>State Machine and State Pattern</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">⬇⬇   ⬇    ⬇  </span><br><span class="line">&lt;div&gt;test&lt;/div&gt;</span><br></pre></td></tr></table></figure><p><img src="../images/lexing-process.png" alt=""></p><p>If we use a very short code snippet as an example, each arrow would point to a state like <code>TagOpen</code>, <code>TagName</code>, <code>Data</code>, <code>EndTagOpen</code>. I just list two of them in the below:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * States and transition activations for the Tokeniser.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">enum</span> TokeniserState &#123;</span><br><span class="line">    Data &#123;</span><br><span class="line">        <span class="comment">// in data state, gather characters until a character reference or tag is found</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">(Tokeniser t, CharacterReader r)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">switch</span> (r.current()) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'&amp;'</span>:</span><br><span class="line">                    t.advanceTransition(CharacterReferenceInData);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'&lt;'</span>:</span><br><span class="line">                    t.advanceTransition(TagOpen);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> nullChar:</span><br><span class="line">                    t.error(<span class="keyword">this</span>); <span class="comment">// NOT replacement character (oddly?)</span></span><br><span class="line">                    t.emit(r.consume());</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> eof:</span><br><span class="line">                    t.emit(<span class="keyword">new</span> Token.EOF());</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    String data = r.consumeData();</span><br><span class="line">                    t.emit(data);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    TagOpen &#123;</span><br><span class="line">        <span class="comment">// from &lt; in data</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">(Tokeniser t, CharacterReader r)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">switch</span> (r.current()) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'!'</span>:</span><br><span class="line">                    t.advanceTransition(MarkupDeclarationOpen);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'/'</span>:</span><br><span class="line">                    t.advanceTransition(EndTagOpen);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'?'</span>:</span><br><span class="line">                    t.advanceTransition(BogusComment);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">if</span> (r.matchesLetter()) &#123;</span><br><span class="line">                        t.createTagPending(<span class="keyword">true</span>);</span><br><span class="line">                        t.transition(TagName);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        t.error(<span class="keyword">this</span>);</span><br><span class="line">                        t.emit(<span class="string">'&lt;'</span>); <span class="comment">// char that got us here</span></span><br><span class="line">                        t.transition(Data);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Understand the idea of <code>Token</code> parse we can go to <code>TreeBuilder</code> process, we will go to the core section first, then go to <code>XmlTreeReader</code> which is easier. We will talk about <code>HtmlTreeReader</code> at last.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">runParser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        Token token = tokeniser.read();</span><br><span class="line">        <span class="comment">// protected abstract boolean process(Token token);</span></span><br><span class="line">        process(token);</span><br><span class="line">        token.reset();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (token.type == Token.TokenType.EOF)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>As for <code>Tokeniser#read()</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Token <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (!isEmitPending)</span><br><span class="line">        state.read(<span class="keyword">this</span>, reader);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if emit is pending, a non-character token was found: return any chars in buffer, and leave token for next read:</span></span><br><span class="line">    <span class="keyword">if</span> (charsBuilder.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        String str = charsBuilder.toString();</span><br><span class="line">        charsBuilder.delete(<span class="number">0</span>, charsBuilder.length());</span><br><span class="line">        charsString = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">return</span> charPending.data(str);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (charsString != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Token token = charPending.data(charsString);</span><br><span class="line">        charsString = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        isEmitPending = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span> emitPending;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="XmlTreeBuilder-First"><a href="#XmlTreeBuilder-First" class="headerlink" title="XmlTreeBuilder First"></a>XmlTreeBuilder First</h3><p>After exploring the Lexing part we can go to the Parsing part now. We will go through the easier part <code>XmlTreeBuilder</code> first, focusing on its implementation of method <code>process(token)</code> in abstract class <code>TreeBuilder</code>.</p><p><code>XmlTreeBuilder</code> basically maintains a stack and insert node according to token type:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Token token)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// start tag, end tag, doctype, comment, character, eof</span></span><br><span class="line">    <span class="keyword">switch</span> (token.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> StartTag:</span><br><span class="line">            insert(token.asStartTag());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> EndTag:</span><br><span class="line">            popStackToClose(token.asEndTag());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Comment:</span><br><span class="line">            insert(token.asComment());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Character:</span><br><span class="line">            insert(token.asCharacter());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Doctype:</span><br><span class="line">            insert(token.asDoctype());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> EOF: <span class="comment">// could put some normalisation here if desired</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            Validate.fail(<span class="string">"Unexpected token type: "</span> + token.type);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>As for <code>insert</code>, we will just use <code>StartTag</code> as an example in the below. The other <code>insert</code> methods accept different types of <code>Token</code> but the idea is the same.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Element <span class="title">insert</span><span class="params">(Token.StartTag startTag)</span> </span>&#123;</span><br><span class="line">    Tag tag = Tag.valueOf(startTag.name(), settings);</span><br><span class="line">    Element el = <span class="keyword">new</span> Element(tag, baseUri, settings.normalizeAttributes(startTag.attributes));</span><br><span class="line">    insertNode(el);</span><br><span class="line">    <span class="keyword">if</span> (startTag.isSelfClosing()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!tag.isKnownTag()) <span class="comment">// unknown tag, remember this is self closing for output. see above.</span></span><br><span class="line">            tag.setSelfClosing();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        stack.add(el);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> el;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="HtmlTreeBuilder-Last"><a href="#HtmlTreeBuilder-Last" class="headerlink" title="HtmlTreeBuilder Last"></a>HtmlTreeBuilder Last</h3><p>Compared to <code>XmlTreeBuilder</code>, <code>HtmlTreeBuilder</code> is much more complex. It introduces <code>HtmlTreeBuilderState</code> to process transitions. As Html is relatively loose in syntax and error tolerance, Jsoup won’t simply quit when certain kinds of error detected, but choose to record them and continue. It will also try to close those tags not closed properly. Some nested tags have sequence restriction, such as a <code>&lt;td&gt;</code> must be under <code>&lt;th&gt;</code> or <code>&lt;tr&gt;</code>, while <code>tr</code> must be under <code>&lt;tbody&gt;</code> or <code>&lt;table</code>.</p><p>There are currently 23 <code>HtmlTreeBuilderState</code> and we will use a typical Html snippet as an example, which came from Yihua Huang’s work. Comments like <code>&lt;!-- State: --&gt;</code> will indicate what kind of <code>HtmlTreeBuilderState</code> we are at.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- State: Initial --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- State: BeforeHtml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">'zh-CN'</span> <span class="attr">xml:lang</span>=<span class="string">'zh-CN'</span> <span class="attr">xmlns</span>=<span class="string">'http://www.w3.org/1999/xhtml'</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- State: BeforeHead --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- State: InHead --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="xml">    //<span class="comment">&lt;!-- State: Text --&gt;</span></span></span><br><span class="line"><span class="undefined">    function xx()&#123;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">noscript</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- State: InHeadNoscript --&gt;</span></span><br><span class="line">    Your browser does not support JavaScript!</span><br><span class="line">    <span class="tag">&lt;/<span class="name">noscript</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- State: AfterHead --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- State: InBody --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textarea</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- State: Text --&gt;</span></span><br><span class="line">    xxx</span><br><span class="line"><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- State: InTable --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- State: InTableText --&gt;</span></span><br><span class="line">    xxx</span><br><span class="line">    <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- State: InTableBody --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- State: InRow --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- State: InCell --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>As we said before, nested tags such as <code>tr</code> cannot be under <code>body</code> directly, they need to be organized under <code>table</code> or <code>tbody</code>. And DOCTYPE declaration also should not be seen in <code>body</code>. In method <code>boolean process(Token t, HtmlTreeBuilder tb)</code> of <code>InBody</code>, there is a case to handle this.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> Doctype: &#123;</span><br><span class="line">    tb.error(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>If <code>head</code> was not closed before <code>body</code>, Jsoup will auto-close it.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">InHead &#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Token t, HtmlTreeBuilder tb)</span> </span>&#123;...&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">anythingElse</span><span class="params">(Token t, TreeBuilder tb)</span> </span>&#123;</span><br><span class="line">        tb.processEndTag(<span class="string">"head"</span>);</span><br><span class="line">        <span class="keyword">return</span> tb.process(t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>As the State Pattern implementation needs to handle many different kinds of cases, one can be easily lost while reading the source code. Understanding the concept and general ideas first will be of help while debugging the code to know what Jsoup is doing, but still, it’s not easy and would hurt your brain😭</p><p><strong>-To Be Continued-</strong></p><iframe src="//rcm-na.amazon-adsystem.com/e/cm?o=1&p=26&l=ur1&category=books&banner=0GDEZK2MM2XGCEH7M202&f=ifr&linkID=f49148e08b4bc8e9cc3a88640a5e74a3&t=javaneversleep-20&tracking_id=javaneversleep-20" width="468" height="60" scrolling="no" border="0" marginwidth="0" style="border:none;" frameborder="0"></iframe>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Ready? The challenging task finally came. We will build a tree this time so that you don’t have to traverse before it was built.😅&lt;code&gt;TreeBuilder&lt;/code&gt; has two implementations, &lt;code&gt;XmlTreeBuilder&lt;/code&gt; is relatively easy while &lt;code&gt;HtmlTreeBuilder&lt;/code&gt; is much more complex. And we will go through them today.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://www.dropbox.com/s/lomj0ikzg2es1j4/build-tree.jpg?dl=1&quot; alt=&quot;&quot;&gt;
    
    </summary>
    
      <category term="Code Review" scheme="http://www.javaneversleep.com/categories/Code-Review/"/>
    
    
      <category term="Jsoup" scheme="http://www.javaneversleep.com/tags/Jsoup/"/>
    
  </entry>
  
  <entry>
    <title>Behind-the-Scenes Secrets of Jsoup II: Traverse A Tree Before It Was Built</title>
    <link href="http://www.javaneversleep.com/Behind-the-Scenes-Secrets-of-Jsoup-02-Node-Traverse/"/>
    <id>http://www.javaneversleep.com/Behind-the-Scenes-Secrets-of-Jsoup-02-Node-Traverse/</id>
    <published>2019-01-12T16:39:26.000Z</published>
    <updated>2020-03-17T23:22:01.732Z</updated>
    
    <content type="html"><![CDATA[<p>Here we go! We’ve got a HTML or XML snippet, it would be clean or dirty, small or large, safe or dangerous, but our task won’t change. We need to extract and manipulate data supporting the best of DOM, CSS, and jquery-like methods. The basic idea would be crystal clear, you need to build a DOM tree and traverse it with or without filtering. That’s it. Sounds easy, right?😅Then Just Do It…and you would probably…cry.</p><p><img src="https://www.dropbox.com/s/2odd7dvop35raub/tree.jpg?dl=1" alt=""><a id="more"></a></p><p>A tree consists of a root node and its children from top to bottom. So it’s straightforward to get the root node first, retrieve its attributes then traverse to its child nodes and maintain the relationship at the same time. The class diagram of <code>org.jsoup.nodes</code> generated by Intellij IDEA is like this:</p><p><img src="https://www.dropbox.com/s/k92qrrrtq5976wx/jsoup-nodes-uml.png?dl=1" alt=""></p><p>PS: LeafNode was introduced in <em>1.11.1</em> for memory usage optimization. “By refactoring the node hierarchy to not track childnodes or attributes by default for lead nodes. For the average document, that’s about a 30% memory reduction.” You can get more details on <a href="https://github.com/jhy/jsoup/issues/911" target="_blank" rel="noopener">#911</a>, which was a good example of performance improvement.</p><p>Besides other classes will be introduced in the future, <code>Element</code> and <code>Document</code> would be most frequently used, but <code>Node</code> is the root of the inheritance tree. Fields and methods worthy of notice are listed in the below:</p><ul><li><code>attributes</code>: key-value collection. Key like ‘type’, ‘id’, ‘name’, ‘value’ and etc. Jsoup especially maintains a list of boolean attribute keys such as ‘checked’(for example: <code>&lt;input type=&quot;checkbox&quot; checked value=&quot;Registered&quot; /&gt;</code>). Literally, two classes <code>Attributes</code> and <code>Attribute</code> are mapped correspondingly. A node can read and write attributes, which provides the ability to clean, correct given HTML</li><li><code>parentNode</code>, <code>childNodes</code> and <code>siblingNodes</code> will be used to access nodes related to current</li><li><code>baseUri()</code> that will be used to convert relative URL address to absolute</li></ul><p>I would talk more about Node traverse in “CSS Selector” part while touching a little bit here first. Slightly different from <a href="https://github.com/code4craft" target="_blank" rel="noopener">Yihua Huang</a>‘s interpretation, <a href="https://github.com/jhy" target="_blank" rel="noopener">Jonathan</a> made some refactorings here, but the concept is still the same. These lines of code in class <a href="https://github.com/jhy/jsoup/blob/master/src/main/java/org/jsoup/select/NodeTraversor.java#L40" target="_blank" rel="noopener"><code>NodeTraversor</code></a> play an important role in the whole picture:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">traverse</span><span class="params">(NodeVisitor visitor, Node root)</span> </span>&#123;</span><br><span class="line">    Node node = root;</span><br><span class="line">    <span class="keyword">int</span> depth = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (node != <span class="keyword">null</span>) &#123;</span><br><span class="line">        visitor.head(node, depth);</span><br><span class="line">        <span class="keyword">if</span> (node.childNodeSize() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            node = node.childNode(<span class="number">0</span>);</span><br><span class="line">            depth++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (node.nextSibling() == <span class="keyword">null</span> &amp;&amp; depth &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                visitor.tail(node, depth);</span><br><span class="line">                node = node.parentNode();</span><br><span class="line">                depth--;</span><br><span class="line">            &#125;</span><br><span class="line">            visitor.tail(node, depth);</span><br><span class="line">            <span class="keyword">if</span> (node == root)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            node = node.nextSibling();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Using recursion here is dangerous, though much easier. <code>StackOverflowError</code> might occur if the DOM tree is too deep. Iterate through is a must here. Don’t tell me you want to use <code>-Xss256M</code> to silence the world.😅</p><p>I want to emphasize that <code>NodeVisitor</code> is an interface. It defines what you would do when a node is first visited and last visited.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">NodeVisitor</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Callback for when a node is first visited.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">head</span><span class="params">(Node node, <span class="keyword">int</span> depth)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Callback for when a node is last visited, after all of its descendants have been visited.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">tail</span><span class="params">(Node node, <span class="keyword">int</span> depth)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Implementations such as <code>Accumulator</code> would be used to collect nodes that pass evaluations parsed from the query, that’s actually the key point of <code>document.select(&quot;${selector}&quot;)</code>. Go to class <code>Collector</code> and you will find it:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Build a list of elements, by visiting root and every descendant of root, and testing it against the evaluator.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> eval Evaluator to test elements against</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> root root of tree to descend</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> list of matches; empty if none</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Elements <span class="title">collect</span> <span class="params">(Evaluator eval, Element root)</span> </span>&#123;</span><br><span class="line">    Elements elements = <span class="keyword">new</span> Elements();</span><br><span class="line">    NodeTraversor.traverse(<span class="keyword">new</span> Accumulator(root, elements, eval), root);</span><br><span class="line">    <span class="keyword">return</span> elements;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Accumulator</code> kept a reference to the node where traverse begins (which means it doesn’t necessarily need to be root), and update <code>elements</code> which you may think of as an <code>ArrayList</code> for simplification.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Accumulator</span> <span class="keyword">implements</span> <span class="title">NodeVisitor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Element root;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Elements elements;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Evaluator eval;</span><br><span class="line"></span><br><span class="line">    Accumulator(Element root, Elements elements, Evaluator eval) &#123;</span><br><span class="line">        <span class="keyword">this</span>.root = root;</span><br><span class="line">        <span class="keyword">this</span>.elements = elements;</span><br><span class="line">        <span class="keyword">this</span>.eval = eval;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">head</span><span class="params">(Node node, <span class="keyword">int</span> depth)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (node <span class="keyword">instanceof</span> Element) &#123;</span><br><span class="line">            Element el = (Element) node;</span><br><span class="line">            <span class="keyword">if</span> (eval.matches(root, el))</span><br><span class="line">                elements.add(el);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tail</span><span class="params">(Node node, <span class="keyword">int</span> depth)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// void</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Other <code>NodeVisitor</code> implementations such as <code>FormattingVisitor</code>, <code>CleaningVisitor</code>, <code>OuterHtmlVisitor</code>, <code>W3CBuilder</code> are also used in certain scenarios. <code>NodeTraversor</code> reuses the depth-first search process and provides the convenience of extra behaviors in the process, which makes the code clean and consistent.</p><p>However, I guess you would be very confused till now. Why the hack you begin from node traverse first? We even don’t have a tree built!</p><p>Yes, exactly. But remember, you have to begin with the end in mind. You always want to find DOM elements matching given search criteria, so the first thing you will think of is actually traversing, it will also affect how you build the tree - perhaps I should say “parse the tree” here.</p><p>And it will touch the topics of Compilers. Fortunately, we don’t need to dig into this mysterious area. Lex and Parse are enough to achieve the goal. And we will talk about State Machine and State Pattern in the next article.</p><p><strong>-To Be Continued-</strong></p><iframe src="//rcm-na.amazon-adsystem.com/e/cm?o=1&p=48&l=ur1&category=books&banner=1WV938XZP3V21MG4E2R2&f=ifr&linkID=e7768772313eb7f959874992156fcfdf&t=javaneversleep-20&tracking_id=javaneversleep-20" width="728" height="90" scrolling="no" border="0" marginwidth="0" style="border:none;" frameborder="0"></iframe>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Here we go! We’ve got a HTML or XML snippet, it would be clean or dirty, small or large, safe or dangerous, but our task won’t change. We need to extract and manipulate data supporting the best of DOM, CSS, and jquery-like methods. The basic idea would be crystal clear, you need to build a DOM tree and traverse it with or without filtering. That’s it. Sounds easy, right?😅Then Just Do It…and you would probably…cry.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://www.dropbox.com/s/2odd7dvop35raub/tree.jpg?dl=1&quot; alt=&quot;&quot;&gt;
    
    </summary>
    
      <category term="Code Review" scheme="http://www.javaneversleep.com/categories/Code-Review/"/>
    
    
      <category term="Jsoup" scheme="http://www.javaneversleep.com/tags/Jsoup/"/>
    
  </entry>
  
  <entry>
    <title>Behind-the-Scenes Secrets of Jsoup I: Introduction</title>
    <link href="http://www.javaneversleep.com/Behind-the-Scenes-Secrets-of-Jsoup-01-Introduction/"/>
    <id>http://www.javaneversleep.com/Behind-the-Scenes-Secrets-of-Jsoup-01-Introduction/</id>
    <published>2019-01-11T16:36:22.000Z</published>
    <updated>2020-03-17T23:22:01.731Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/jhy/jsoup/" target="_blank" rel="noopener">Jsoup</a> would probably be the most popular “working with real-world HTML” library in the Java community. I’ve been using it for web crawler stuff since <em>1.7.3</em>(latest release is <em>1.11.3</em>), but a little bit surprised to see that there is little introduction or analysis regarding its source code and implementations.</p><p><img src="https://www.dropbox.com/s/ueo3ej917f12hu1/jsoup.jpg?dl=1" alt=""><a id="more"></a></p><p>Since I will use Jsoup as an example for <a href="http://oit.olivetuniversity.edu/academics/macourses.htm" target="_blank" rel="noopener">OOP course(SE500)</a> I would teach at <a href="http://oit.olivetuniversity.edu/" target="_blank" rel="noopener">Olivet Institute of Technology</a> from Jan 2019, I tried to summarize the most important ideas behind-the-scene so that at least I know what I will talk about.😅These series were inspired from <a href="https://github.com/code4craft/jsoup-learning" target="_blank" rel="noopener">jsoup-learning</a> and reused some graphs from it. Many thanks for <a href="https://github.com/code4craft" target="_blank" rel="noopener">Yihua Huang</a>‘s digging into this beautiful library.</p><p>This is the first part of the series. I will give a brief introduction about features of Jsoup and its general code structure. After that, I will analyze the DOM parser and CSS selector implementation mechanism, plus with some interesting tips and tricks in following articles.</p><p>Jsoup is developed by <a href="https://jhy.io/" target="_blank" rel="noopener">Jonathan Hedley</a>, a Senior Manager of Software Development at Amazon. According to the <a href="https://github.com/jhy/jsoup/blob/master/CHANGES" target="_blank" rel="noopener">change logs</a>, the initial beta was released at Jan 31, 2010, so it has been about <strong>9 years</strong> till now! He is still maintaining the code base regularly, though not that actively as before. It might be due to “jsoup is in general, stable release” as he said.</p><p>I use the latest version <em>1.12.1-SNAPSHOT</em> for these series. It’s a <a href="https://maven.apache.org/" target="_blank" rel="noopener">Maven</a> project without any external dependencies, though it introduced junit, gson, and jetty for unit test and integration test usage. According to the statistic result of <a href="https://github.com/AlDanial/cloc" target="_blank" rel="noopener">cloc</a>, there are <strong>68</strong> Java source files under <code>src\main\java</code>, <strong>12015</strong> lines of code, <strong>4177</strong> lines of comment and <strong>1991</strong> blank lines. As a library with good test coverage, there are <strong>46</strong> Java source files under <code>src\test\java</code>, with <strong>7911</strong> lines of code, <strong>350</strong> lines of comment and <strong>1672</strong> blank lines.</p><p>The percentage of test code against production code is <strong>65.8%</strong>, which is pretty good. As for test coverage, Intellij IDEA code coverage runner gives the report in the below, which is also impressive.</p><table><thead><tr><th>Package</th><th>Class, %</th><th>Method, %</th><th>Line, %</th></tr></thead><tbody><tr><td>org.jsoup</td><td>98% (229/233)</td><td>87% (1269/1457)</td><td>83% (6135/7317)</td></tr><tr><td>org.jsoup.helper</td><td>100% (11/11)</td><td>79% (138/174)</td><td>83% (692/824)</td></tr><tr><td>org.jsoup.internal</td><td>100% (3/3)</td><td>100% (27/27)</td><td>95% (141/147)</td></tr><tr><td>org.jsoup.nodes</td><td>96% (31/32)</td><td>87% (356/407)</td><td>88% (1286/1455)</td></tr><tr><td>org.jsoup.parser</td><td>100% (114/114)</td><td>91% (490/535)</td><td>79% (2924/3699)</td></tr><tr><td>org.jsoup.safety</td><td>100% (9/9)</td><td>100% (44/44)</td><td>95% (286/300)</td></tr><tr><td>org.jsoup.select</td><td>100% (58/58)</td><td>81% (193/237)</td><td>92% (772/836)</td></tr></tbody></table><p>You may find that package <code>org.jsoup.examples</code> is missing here. Since it is used as a showcase, it’s reasonable that there is no need to write tests against them, thus I exclude it. It might be better to remove them out of production code and extract to another project with more examples covering most frequent scenarios - just in my opinion.</p><p>As a widely used library aiming at “working with real-world HTML”, the higher the test coverage is, the better. I’ve heard that Evan You, author of <a href="https://github.com/vuejs" target="_blank" rel="noopener">Vue.js</a>, even achieved 100% unit test coverage! 669 test cases make sure Jsoup stay at good status - but this still cannot prevent new issues happen. Anyway, real-world is always a crazy world, go to the test cases and you will believe what I said. For example, <code>&lt;p =a&gt;One&lt;a &lt;p&gt;Something&lt;/p&gt;Else</code>, <code>&lt;div id=1&lt;p id=&#39;2&#39;</code>, what the hack is this? what should be the expected correct parsing result? Can you figure them out in 5 seconds?😭</p><p>Even though Jsoup is well covered by unit tests and maintains a high quality of implementation, you still need to be very careful when you prepare to upgrade to a new version - actually this is something to be self-evident - you just need more and more test cases to make your life easier. I remember very clearly in Dec 2016, some of my unit tests suddenly failed after I upgraded from <em>1.8.3</em> to <em>1.10.1</em> without doing anything else. Since my software was used by thousands of clients, I immediately report an <a href="https://github.com/jhy/jsoup/issues/803" target="_blank" rel="noopener">issue</a> in Github and rollback to 1.8.3 for a while, I just can’t imagine what will happen if I simply upgrade it, you know, some bugs just appear in certain circumstances and not easy to reproduce in normal functional tests.</p><p>From the test coverage result, you will also get a whole picture of code structure. While jsoup providing convenient methods to submit HTTP requests and get responses, the most important parts are still under package <code>org.jsoup.parse</code> and <code>org.jsoup.select</code>. I will introduce them in the 2nd and 3rd articles of these series. The 5 lines of code in the below, covering most frequently used scenarios, are fairly clean, easy and simple, which only means Jsoup did quite a good job for its API user experience.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Document doc = Jsoup.connect(<span class="string">"https://en.wikipedia.org"</span>).get();</span><br><span class="line">Elements newsHeadlines = doc.select(<span class="string">"#mp-itn b a"</span>);</span><br><span class="line"><span class="keyword">for</span> (Element headline : newsHeadlines) &#123;</span><br><span class="line">    log(<span class="string">"%s\n\t%s"</span>, headline.attr(<span class="string">"title"</span>), headline.absUrl(<span class="string">"href"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Jsoup also provides a website for you to play around with its <a href="https://jsoup.org/apidocs/org/jsoup/select/Selector.html" target="_blank" rel="noopener">selector</a>. <a href="https://try.jsoup.org/" target="_blank" rel="noopener">Try Jsoup</a> is the place where you can explore features of Jsoup without writing one line of code. It is also created for issue report. You can save the input, parameters, and output so that those who want to help you will go to the point much faster. For example, I want to retrieve all the post titles of Old Young Boys Club: <a href="http://try.jsoup.org/~iZFlhTQQAZnkXoPSCKrG4OisFcg" target="_blank" rel="noopener">http://try.jsoup.org/~iZFlhTQQAZnkXoPSCKrG4OisFcg</a>. The upgrade issue I mentioned above also had a corresponding session link <a href="http://try.jsoup.org/~NOfOU7vXHAaHWhDnHv5qBIPtE1M" target="_blank" rel="noopener">http://try.jsoup.org/~NOfOU7vXHAaHWhDnHv5qBIPtE1M</a> still available today.👍</p><p>After you get familiar with the features of Jsoup, it’s time to go to source code to understand the mechanism. I would suggest you run class <code>org.jsoup.examples.Wikipedia</code> and debug the 5 lines of code above to see what actually happened step by step. Beware, it’s a long journey. If you get stuck you may also go over the test cases to understand what kind of problems the code will resolve - and how you would resolve. It’s also helpful to fork the repository and try to submit some pull requests, you may either pick up an issue and try to fix or make some minor enhancements. Actually, I just submitted Pull Requests <a href="https://github.com/jhy/jsoup/pull/1157" target="_blank" rel="noopener">#1157</a> and <a href="https://github.com/jhy/jsoup/pull/1158" target="_blank" rel="noopener">#1158</a> yesterday plus two issues: <a href="https://github.com/jhy/jsoup/issues/1156" target="_blank" rel="noopener">#1156</a> and <a href="https://github.com/jhy/jsoup/issues/1159" target="_blank" rel="noopener">#1159</a>. I hope Jonathan would accept my PR and consider fixing these issues.😅</p><p>PS: Once there was a Japanese Samurai who submitted a Pull Request <a href="https://github.com/jhy/jsoup/pull/564" target="_blank" rel="noopener">#564</a> at Apr 27, 2015, got approved and merged at Nov 19, 2017. He recorded this unforgettable experience in twitter.</p><p><blockquote class="twitter-tweet tw-align-center" data-lang="en"><p lang="en" dir="ltr">Thanks – better late than never :)</p>&mdash; Jonathan Hedley (@jhy) <a href="https://twitter.com/jhy/status/932505536662183936?ref_src=twsrc%5Etfw" target="_blank" rel="noopener">November 20, 2017</a></blockquote></p><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p><strong>-To Be Continued-</strong></p><iframe src="//rcm-na.amazon-adsystem.com/e/cm?o=1&p=48&l=ur1&category=books&banner=0HX1M2P8DDZ20D689R82&f=ifr&linkID=61f529dfb8b35107c92efc29a2c3c8dc&t=javaneversleep-20&tracking_id=javaneversleep-20" width="728" height="90" scrolling="no" border="0" marginwidth="0" style="border:none;" frameborder="0"></iframe>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://github.com/jhy/jsoup/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Jsoup&lt;/a&gt; would probably be the most popular “working with real-world HTML” library in the Java community. I’ve been using it for web crawler stuff since &lt;em&gt;1.7.3&lt;/em&gt;(latest release is &lt;em&gt;1.11.3&lt;/em&gt;), but a little bit surprised to see that there is little introduction or analysis regarding its source code and implementations.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://www.dropbox.com/s/ueo3ej917f12hu1/jsoup.jpg?dl=1&quot; alt=&quot;&quot;&gt;
    
    </summary>
    
      <category term="Code Review" scheme="http://www.javaneversleep.com/categories/Code-Review/"/>
    
    
      <category term="Jsoup" scheme="http://www.javaneversleep.com/tags/Jsoup/"/>
    
  </entry>
  
</feed>
